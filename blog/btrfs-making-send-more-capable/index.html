<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>btrfs: making &#34;send&#34; more &#34;capable&#34; | Marcos&#39; Blog</title>
<meta name="keywords" content="">
<meta name="description" content="The tale of fixing a problem of send/receive on btrfs.">
<meta name="author" content="Marcos Paulo de Souza">
<link rel="canonical" href="https://mpdesouza.com/blog/btrfs-making-send-more-capable/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mpdesouza.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mpdesouza.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mpdesouza.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mpdesouza.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://mpdesouza.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWD0KKCW2G"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LWD0KKCW2G', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="btrfs: making &#34;send&#34; more &#34;capable&#34;" />
<meta property="og:description" content="The tale of fixing a problem of send/receive on btrfs." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/blog/btrfs-making-send-more-capable/" />
<meta property="og:image" content="https://mpdesouza.com/images/mailbox.jpg" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2020-05-14T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-05-14T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mpdesouza.com/images/mailbox.jpg" />
<meta name="twitter:title" content="btrfs: making &#34;send&#34; more &#34;capable&#34;"/>
<meta name="twitter:description" content="The tale of fixing a problem of send/receive on btrfs."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blog",
      "item": "https://mpdesouza.com/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "btrfs: making \"send\" more \"capable\"",
      "item": "https://mpdesouza.com/blog/btrfs-making-send-more-capable/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "btrfs: making \"send\" more \"capable\"",
  "name": "btrfs: making \u0022send\u0022 more \u0022capable\u0022",
  "description": "The tale of fixing a problem of send/receive on btrfs.",
  "keywords": [
    
  ],
  "articleBody": "The send/receive is a feature from btrfs where you can generate a stream of changes between two snapshots and then apply to any btrfs system, being a different disk on the host or over the network.\nThe receive feature receives a stream of data, applying the it in the filesystem. As the stream can be a file, it’s easy even to transfer the output of send over the network and receive in the other side. Here is an example of how this works:\n1 $ btrfs send /mnt/my_snapshot | ssh user@host \"btrfs receive /mnt/my_backup\" In this example, we are doing what we call a full send, which sends all data to the remote side. We can see what is being processed by the receiving side by using --dump argument:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 # creating a \"disk\" and the btrfs filesystem $ truncate -s 10G btrfs.disk $ mkfs.btrfs -f btrfs.disk # creating a subvolume and a snapshot with one file $ mount btrfs.disk /mnt $ btrfs subvolume create /mnt/vol1 Create subvolume '/mnt/vol1' $ touch /mnt/vol1/file.txt $ btrfs subvolume snapshot -r /mnt/vol1/ /mnt/snap1 Create a readonly snapshot of '/mnt/vol1/' in '/mnt/snap1' # create a full send stream from snap1 $ btrfs send /mnt/snap1 -f send.dump # dumping the contents of the stream $ btrfs receive -f send.dump --dump subvol ./snap1 uuid=50ce3050-4ff1-f441-8202-7e49f3ac9657 transid=7 chown ./snap1/ gid=0 uid=0 chmod ./snap1/ mode=755 utimes ./snap1/ atime=2020-05-08T16:32:50-0300 mtime=2020-05-08T16:33:07-0300 ctime=2020-05-08T16:33:07-0300 mkfile ./snap1/o257-7-0 rename ./snap1/o257-7-0 dest=./snap1/file.txt utimes ./snap1/ atime=2020-05-08T16:32:50-0300 mtime=2020-05-08T16:33:07-0300 ctime=2020-05-08T16:33:07-0300 chown ./snap1/file.txt gid=0 uid=0 chmod ./snap1/file.txt mode=644 utimes ./snap1/file.txt atime=2020-05-08T16:33:07-0300 mtime=2020-05-08T16:33:07-0300 ctime=2020-05-08T16:33:07-0300 # creating a subvolume to store the backups (this coudld be done in a different disk) $ btrfs subvolume create /mnt/bkp Create subvolume '/mnt/bkp' # applying the receiving the stream $ btrfs receive -f send.dump /mnt/bkp $ ls /mnt/bkp/snap1/file.txt /mnt/bkp/snap1/file.txt As we could see by the outputs above, the full send really specifies all actions, from the first snapshot creation, creation of files, adding a owner/group/mode and access time.\nAfter we have a backup, we can send just incremental changes. We call this an incremental send. We use a parent snapshot (-p argument) and compare it with a new snapshot. Look at the example below, using the same snapshots created in the steps above:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 # changing user/group of file.txt $ ls -l /mnt/vol1/file.txt -rw-r--r-- 1 root root 0 May 8 16:33 /mnt/vol1/file.txt $ chgrp 100 /mnt/vol1/file.txt $ chown users /mnt/vol1/file.txt $ ls -l /mnt/vol1/file.txt -rw-r--r-- 1 marcos users 0 May 8 16:33 /mnt/vol1/file.txt # create a new snapshot based in the current version of vol1 $ btrfs subvolume snapshot -r /mnt/vol1/ /mnt/snap2 Create a readonly snapshot of '/mnt/vol1/' in '/mnt/snap2' # create a new stream by comparing snap1 with snap2, and dumping the changes $ btrfs send -p /mnt/snap1/ /mnt/snap2 -f send.dump $ btrfs receive -f send.dump --dump snapshot ./snap2 uuid=16343add-4e38-e343-9af2-f64ff7d4b61d transid=15 parent_uuid=50ce3050-4ff1-f441-8202-7e49f3ac9657 parent_transid=7 utimes ./snap2/ atime=2020-05-08T16:41:26-0300 mtime=2020-05-08T16:33:07-0300 ctime=2020-05-08T16:33:07-0300 chown ./snap2/file.txt gid=100 uid=1001 utimes ./snap2/file.txt atime=2020-05-08T16:33:07-0300 mtime=2020-05-08T16:33:07-0300 ctime=2020-05-08T16:42:06-0300 # applying changes $ btrfs receive -f send.dump /mnt/bkp/ $ ls -l /mnt/bkp/snap2/file.txt -rw-r--r-- 1 marcos users 0 May 8 16:33 /mnt/bkp/snap2/file.txt This is what we call an incremental send. In this case, if we have a file that exists in both snapshots, but in the most recent one it only changed the owner/group, the send stream will contain only the chown command, instead of copying the content of the file over the network again. The receive side will apply the chown, and then the filesystem on the remote/local host will have the content of the most recent version.\nThis feature works nicely for all users, but there is a corner case when it comes to file capabilities.\nWhat is the problem with capabilities? Capabilities can be set per file, and they are meant to give part of the root powers to a common binary to be executed like it’s root, but without the over permissive setuid bit.\nWith the setuid, the application runs as root, but using capabilities the application still runs as your current user, but with a subset of the root powers, like CAP_KILL (the permission to kill other programs) or CAP_SYS_NICE (the permission to change the priority of other processes).\nIf you change the user or group of a file with capabilities, the kernel drops the capability.\nThe problem is: if you have a parent snapshot that contains a file with capabilities and the file changed the owner and later restored the capability, the current kernel code emits only the chown, making the receive side to drop the capability, even if the parent snapshot still has the same capability set.\nThis problem exists in all stable releases since v4.4.\nIt’s easy to reproduce the problem:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 # create a new sparse file with 5G of size, and create a btrfs fs on it $ fallocate -l5G disk.btrfs $ mkfs.btrfs disk.btrfs # mount the fs and create subvolumes fs1 and fs2 $ mount disk.btrfs /mnt $ btrfs subvolume create /mnt/fs1 $ btrfs subvolume create /mnt/fs2 # create a foo.bar file on fs1,and set a capabilities on it $ touch /mnt/fs1/foo.bar $ setcap cap_sys_nice+ep /mnt/fs1/foo.bar # create a readonly snapshot and send to fs2 (full send) $ btrfs subvol snap -r /mnt/fs1 /mnt/fs1/snap_init $ btrfs send /mnt/fs1/snap_init | btrfs receive /mnt/fs2 # change the capability on foo.bar, and restore the capability $ chgrp adm /mnt/fs1/foo.bar $ setcap cap_sys_nice+ep /mnt/fs1/foo.bar # create a new readonly snapshot containing foo.bar with different group $ btrfs subvol snap -r /mnt/fs1 /mnt/fs1/snap_inc # executing an incremental send comparing the two snapshots $ btrfs send -p /mnt/fs1/snap_init /mnt/fs1/snap_inc | btrfs receive fs2 At this point, the foo.bar sent to fs2 lost it’s capability:\n1 2 $ getcap /mnt/fs2/snap_init/foo.bar $ How to fix the issue? Simple: just emit the capabilities after the chown was emitted. The basic idea is:\nEmit chown Check if there are capabilities for this file If yes, emit them Here is a portion of the fix:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 if (need_chown) { ret = send_chown(sctx, sctx-\u003ecur_ino, sctx-\u003ecur_inode_gen, left_uid, left_gid); if (ret \u003c 0) goto out; } if (need_chmod) { ret = send_chmod(sctx, sctx-\u003ecur_ino, sctx-\u003ecur_inode_gen, left_mode); if (ret \u003c 0) goto out; } ret = send_capabilities(sctx); if (ret \u003c 0) goto out; The patch itself is somewhat bigger, and exposes how btrfs managed inodes and its attributes, and I plan to write about it in the future.\nFor the most curious readers, here is the full path. Along with the patch solving the problem, a test was created in xfstests to ensure this problem won’t happen again in the future.\nThe kernel patch was merged in v5.8 and backported to affected all stale kernels.\nThanks for reading! See you in another post!\n",
  "wordCount" : "1197",
  "inLanguage": "en",
  "image":"https://mpdesouza.com/images/mailbox.jpg","datePublished": "2020-05-14T00:00:00Z",
  "dateModified": "2020-05-14T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Marcos Paulo de Souza"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mpdesouza.com/blog/btrfs-making-send-more-capable/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marcos' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mpdesouza.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mpdesouza.com" accesskey="h" title="Marcos&#39; Blog (Alt + H)">Marcos&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mpdesouza.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://mpdesouza.com/about-me/" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mpdesouza.com">Home</a>&nbsp;»&nbsp;<a href="https://mpdesouza.com/blog/">Blog</a></div>
    <h1 class="post-title">
      btrfs: making &#34;send&#34; more &#34;capable&#34;
    </h1>
    <div class="post-meta"><span title='2020-05-14 00:00:00 +0000 UTC'>May 14, 2020</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;Marcos Paulo de Souza

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://mpdesouza.com/images/mailbox.jpg" alt="">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#what-is-the-problem-with-capabilities" aria-label="What is the problem with capabilities?">What is the problem with capabilities?</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>The <strong>send/receive</strong> is a feature from btrfs where you can generate a stream of changes between two snapshots and then apply to any btrfs system, being a different disk on the host or over the network.</p>
<p>The receive feature <em>receives</em> a stream of data, applying the it in the filesystem. As the stream can be a file, it&rsquo;s easy even to transfer the output of <strong>send</strong> over the network and <strong>receive</strong> in the other side. Here is an example of how this works:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ btrfs send /mnt/my_snapshot <span class="p">|</span> ssh user@host <span class="s2">&#34;btrfs receive /mnt/my_backup&#34;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this example, we are doing what we call a <em>full send</em>, which sends all data to the remote side. We can see what is being processed by the receiving side by using <em>--dump</em> argument:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># creating a &#34;disk&#34; and the btrfs filesystem</span>
</span></span><span class="line"><span class="cl">$ truncate -s 10G btrfs.disk
</span></span><span class="line"><span class="cl">$ mkfs.btrfs -f btrfs.disk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># creating a subvolume and a snapshot with one file</span>
</span></span><span class="line"><span class="cl">$ mount btrfs.disk /mnt
</span></span><span class="line"><span class="cl">$ btrfs subvolume create /mnt/vol1
</span></span><span class="line"><span class="cl">Create subvolume <span class="s1">&#39;/mnt/vol1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ touch /mnt/vol1/file.txt
</span></span><span class="line"><span class="cl">$ btrfs subvolume snapshot -r /mnt/vol1/ /mnt/snap1
</span></span><span class="line"><span class="cl">Create a <span class="nb">readonly</span> snapshot of <span class="s1">&#39;/mnt/vol1/&#39;</span> in <span class="s1">&#39;/mnt/snap1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># create a full send stream from snap1</span>
</span></span><span class="line"><span class="cl">$ btrfs send /mnt/snap1 -f send.dump
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># dumping the contents of the stream</span>
</span></span><span class="line"><span class="cl">$ btrfs receive -f send.dump --dump
</span></span><span class="line"><span class="cl">subvol          ./snap1                         <span class="nv">uuid</span><span class="o">=</span>50ce3050-4ff1-f441-8202-7e49f3ac9657 <span class="nv">transid</span><span class="o">=</span><span class="m">7</span>
</span></span><span class="line"><span class="cl">chown           ./snap1/                        <span class="nv">gid</span><span class="o">=</span><span class="m">0</span> <span class="nv">uid</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">chmod           ./snap1/                        <span class="nv">mode</span><span class="o">=</span><span class="m">755</span>
</span></span><span class="line"><span class="cl">utimes          ./snap1/                        <span class="nv">atime</span><span class="o">=</span>2020-05-08T16:32:50-0300 <span class="nv">mtime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">ctime</span><span class="o">=</span>2020-05-08T16:33:07-0300
</span></span><span class="line"><span class="cl">mkfile          ./snap1/o257-7-0
</span></span><span class="line"><span class="cl">rename          ./snap1/o257-7-0                <span class="nv">dest</span><span class="o">=</span>./snap1/file.txt
</span></span><span class="line"><span class="cl">utimes          ./snap1/                        <span class="nv">atime</span><span class="o">=</span>2020-05-08T16:32:50-0300 <span class="nv">mtime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">ctime</span><span class="o">=</span>2020-05-08T16:33:07-0300
</span></span><span class="line"><span class="cl">chown           ./snap1/file.txt                <span class="nv">gid</span><span class="o">=</span><span class="m">0</span> <span class="nv">uid</span><span class="o">=</span><span class="m">0</span>
</span></span><span class="line"><span class="cl">chmod           ./snap1/file.txt                <span class="nv">mode</span><span class="o">=</span><span class="m">644</span>
</span></span><span class="line"><span class="cl">utimes          ./snap1/file.txt                <span class="nv">atime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">mtime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">ctime</span><span class="o">=</span>2020-05-08T16:33:07-0300
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># creating a subvolume to store the backups (this coudld be done in a different disk)</span>
</span></span><span class="line"><span class="cl">$ btrfs subvolume create /mnt/bkp
</span></span><span class="line"><span class="cl">Create subvolume <span class="s1">&#39;/mnt/bkp&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># applying the receiving the stream</span>
</span></span><span class="line"><span class="cl">$ btrfs receive -f send.dump /mnt/bkp
</span></span><span class="line"><span class="cl">$ ls /mnt/bkp/snap1/file.txt
</span></span><span class="line"><span class="cl">/mnt/bkp/snap1/file.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we could see by the outputs above, the full send really specifies all actions, from the first snapshot creation, creation of files, adding a owner/group/mode and access time.</p>
<p>After we have a backup, we can send just incremental changes. We call this an <!-- raw HTML omitted -->incremental send<!-- raw HTML omitted -->. We use a parent snapshot (-p argument) and compare it with a new snapshot. Look at the example below, using the same snapshots created in the steps above:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># changing user/group of file.txt</span>
</span></span><span class="line"><span class="cl">$ ls -l /mnt/vol1/file.txt                    
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> root root <span class="m">0</span> May  <span class="m">8</span> 16:33 /mnt/vol1/file.txt
</span></span><span class="line"><span class="cl">                                              
</span></span><span class="line"><span class="cl">$ chgrp <span class="m">100</span> /mnt/vol1/file.txt                
</span></span><span class="line"><span class="cl">$ chown users /mnt/vol1/file.txt              
</span></span><span class="line"><span class="cl">$ ls -l /mnt/vol1/file.txt                    
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> marcos users <span class="m">0</span> May  <span class="m">8</span> 16:33 /mnt/vol1/file.txt
</span></span><span class="line"><span class="cl">                                              
</span></span><span class="line"><span class="cl"><span class="c1"># create a new snapshot based in the current version of vol1</span>
</span></span><span class="line"><span class="cl">$ btrfs subvolume snapshot -r /mnt/vol1/ /mnt/snap2
</span></span><span class="line"><span class="cl">Create a <span class="nb">readonly</span> snapshot of <span class="s1">&#39;/mnt/vol1/&#39;</span> in <span class="s1">&#39;/mnt/snap2&#39;</span>
</span></span><span class="line"><span class="cl">                                              
</span></span><span class="line"><span class="cl"><span class="c1"># create a new stream by comparing snap1 with snap2, and dumping the changes</span>
</span></span><span class="line"><span class="cl">$ btrfs send -p /mnt/snap1/ /mnt/snap2 -f send.dump
</span></span><span class="line"><span class="cl">$ btrfs receive -f send.dump --dump           
</span></span><span class="line"><span class="cl">snapshot        ./snap2                         <span class="nv">uuid</span><span class="o">=</span>16343add-4e38-e343-9af2-f64ff7d4b61d <span class="nv">transid</span><span class="o">=</span><span class="m">15</span> <span class="nv">parent_uuid</span><span class="o">=</span>50ce3050-4ff1-f441-8202-7e49f3ac9657 <span class="nv">parent_transid</span><span class="o">=</span><span class="m">7</span>
</span></span><span class="line"><span class="cl">utimes          ./snap2/                        <span class="nv">atime</span><span class="o">=</span>2020-05-08T16:41:26-0300 <span class="nv">mtime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">ctime</span><span class="o">=</span>2020-05-08T16:33:07-0300
</span></span><span class="line"><span class="cl">chown           ./snap2/file.txt                <span class="nv">gid</span><span class="o">=</span><span class="m">100</span> <span class="nv">uid</span><span class="o">=</span><span class="m">1001</span>
</span></span><span class="line"><span class="cl">utimes          ./snap2/file.txt                <span class="nv">atime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">mtime</span><span class="o">=</span>2020-05-08T16:33:07-0300 <span class="nv">ctime</span><span class="o">=</span>2020-05-08T16:42:06-0300
</span></span><span class="line"><span class="cl">                                              
</span></span><span class="line"><span class="cl"><span class="c1"># applying changes                            </span>
</span></span><span class="line"><span class="cl">$ btrfs receive -f send.dump /mnt/bkp/        
</span></span><span class="line"><span class="cl">$ ls -l /mnt/bkp/snap2/file.txt               
</span></span><span class="line"><span class="cl">-rw-r--r-- <span class="m">1</span> marcos users <span class="m">0</span> May  <span class="m">8</span> 16:33 /mnt/bkp/snap2/file.txt
</span></span></code></pre></td></tr></table>
</div>
</div><p>This is what we call an <em>incremental send</em>. In this case, if we have a file that exists in both snapshots, but in the most recent one it only changed the <em>owner/group</em>, the send stream will contain only the <strong>chown</strong> command, instead of copying the content of the file over the network again. The receive side will apply the <strong>chown</strong>, and then the filesystem on the remote/local host will have the content of the most recent version.</p>
<p>This feature works nicely for all users, but there is a corner case when it comes to <a href="http://man7.org/linux/man-pages/man7/capabilities.7.html">file capabilities</a>.</p>
<h2 id="what-is-the-problem-with-capabilities">What is the problem with capabilities?<a hidden class="anchor" aria-hidden="true" href="#what-is-the-problem-with-capabilities">#</a></h2>
<p>Capabilities can be set per file, and they are meant to give part of the <strong>root powers</strong> to a common binary to be executed like it&rsquo;s <strong>root</strong>, but without the over permissive <a href="https://en.wikipedia.org/wiki/Setuid">setuid</a> bit.</p>
<p>With the setuid, the application runs as root, but using capabilities the application still runs as your current user, but with a subset of the root powers, like CAP_KILL (the permission to kill other programs) or CAP_SYS_NICE (the permission to change the priority of other processes).</p>
<p><em>If you change the user or group of a file with capabilities, the kernel drops the capability.</em></p>
<p>The problem is: if you have a parent snapshot that contains a file with capabilities and the file changed the owner and later restored the capability, the current kernel code emits only the chown, making the receive side to drop the capability, even if the parent snapshot still has the same capability set.</p>
<p><strong>This problem exists in all stable releases since v4.4.</strong></p>
<p>It&rsquo;s easy to reproduce the problem:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># create a new sparse file with 5G of size, and create a btrfs fs on it</span>
</span></span><span class="line"><span class="cl">$ fallocate -l5G disk.btrfs                                     
</span></span><span class="line"><span class="cl">$ mkfs.btrfs disk.btrfs                                         
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># mount the fs and create subvolumes fs1 and fs2              </span>
</span></span><span class="line"><span class="cl">$ mount disk.btrfs /mnt                                         
</span></span><span class="line"><span class="cl">$ btrfs subvolume create /mnt/fs1                               
</span></span><span class="line"><span class="cl">$ btrfs subvolume create /mnt/fs2                               
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># create a foo.bar file on fs1,and set a capabilities on it</span>
</span></span><span class="line"><span class="cl">$ touch /mnt/fs1/foo.bar                                        
</span></span><span class="line"><span class="cl">$ setcap cap_sys_nice+ep /mnt/fs1/foo.bar                       
</span></span><span class="line"><span class="cl"><span class="c1"># create a readonly snapshot and send to fs2 (full send)   </span>
</span></span><span class="line"><span class="cl">$ btrfs subvol snap -r /mnt/fs1 /mnt/fs1/snap_init              
</span></span><span class="line"><span class="cl">$ btrfs send /mnt/fs1/snap_init <span class="p">|</span> btrfs receive /mnt/fs2        
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># change the capability on foo.bar, and restore the capability</span>
</span></span><span class="line"><span class="cl">$ chgrp adm /mnt/fs1/foo.bar                                    
</span></span><span class="line"><span class="cl">$ setcap cap_sys_nice+ep /mnt/fs1/foo.bar                       
</span></span><span class="line"><span class="cl">                                                              
</span></span><span class="line"><span class="cl"><span class="c1"># create a new readonly snapshot containing foo.bar with different group</span>
</span></span><span class="line"><span class="cl">$ btrfs subvol snap -r /mnt/fs1 /mnt/fs1/snap_inc               
</span></span><span class="line"><span class="cl"><span class="c1"># executing an incremental send comparing the two snapshots</span>
</span></span><span class="line"><span class="cl">$ btrfs send -p /mnt/fs1/snap_init /mnt/fs1/snap_inc <span class="p">|</span> btrfs receive fs2
</span></span></code></pre></td></tr></table>
</div>
</div><p>At this point, the foo.bar sent to fs2 lost it&rsquo;s capability:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ getcap /mnt/fs2/snap_init/foo.bar 
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><p>How to fix the issue? Simple: just emit the capabilities <strong>after</strong> the chown was emitted. The basic idea is:</p>
<ul>
<li>Emit <strong>chown</strong></li>
<li>Check if there are capabilities for this file</li>
<li>If yes, emit them</li>
</ul>
<p>Here is a portion of the fix:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">need_chown</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">send_chown</span><span class="p">(</span><span class="n">sctx</span><span class="p">,</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">cur_ino</span><span class="p">,</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">cur_inode_gen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">left_uid</span><span class="p">,</span> <span class="n">left_gid</span><span class="p">);</span> 
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>          
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl"><span class="p">}</span>               
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">need_chmod</span><span class="p">)</span> <span class="p">{</span>    
</span></span><span class="line"><span class="cl">        <span class="n">ret</span> <span class="o">=</span> <span class="nf">send_chmod</span><span class="p">(</span><span class="n">sctx</span><span class="p">,</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">cur_ino</span><span class="p">,</span> <span class="n">sctx</span><span class="o">-&gt;</span><span class="n">cur_inode_gen</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">left_mode</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>          
</span></span><span class="line"><span class="cl">                <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>        
</span></span><span class="line"><span class="cl"><span class="p">}</span>               
</span></span><span class="line"><span class="cl">                
</span></span><span class="line"><span class="cl"><span class="n">ret</span> <span class="o">=</span> <span class="nf">send_capabilities</span><span class="p">(</span><span class="n">sctx</span><span class="p">);</span>   
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">        <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The patch itself is somewhat bigger, and exposes how btrfs managed inodes and its attributes, and I plan to write about it in the future.</p>
<p>For the most curious readers, here is the full <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=89efda52e6b6930f80f5adda9c3c9edfb1397191">path</a>. Along with the patch solving the problem, a <a href="https://git.kernel.org/pub/scm/fs/xfs/xfstests-dev.git/commit/?id=a1c25b75b456880f64ab30ced0892f7603e4bb3c">test</a> was created in xfstests to ensure this problem won&rsquo;t happen again in the future.</p>
<p>The kernel patch was merged in v5.8 and backported to affected all stale kernels.</p>
<p>Thanks for reading! See you in another post!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mpdesouza.com/blog/btrfs-differentiating-bind-mounts-on-subvolumes/">
    <span class="title">« Prev</span>
    <br>
    <span>btrfs: Differentiating bind mounts on subvolumes</span>
  </a>
  <a class="next" href="https://mpdesouza.com/blog/new-btrfs-feature-delete-subvolumes-using-subvolume-ids/">
    <span class="title">Next »</span>
    <br>
    <span>New btrfs feature: Delete subvolumes using subvolume ids</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mpdesouza.com">Marcos&#39; Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
