<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Btrfs: Resolving the logical-resolve | Marcos&#39; Blog</title>
<meta name="keywords" content="">
<meta name="description" content="logical-resolve inside out">
<meta name="author" content="Marcos Paulo de Souza">
<link rel="canonical" href="https://mpdesouza.com/blog/btrfs-resolving-the-logical-resolve/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.7140587df96a2b1a49eb723fa7063dc0c641a6cb638f3140e8d3beb4deae4f5c.css" integrity="sha256-cUBYfflqKxpJ63I/pwY9wMZBpstjjzFA6NO&#43;tN6uT1w=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://mpdesouza.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mpdesouza.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mpdesouza.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mpdesouza.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://mpdesouza.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWD0KKCW2G"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LWD0KKCW2G', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Btrfs: Resolving the logical-resolve" />
<meta property="og:description" content="logical-resolve inside out" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/blog/btrfs-resolving-the-logical-resolve/" />
<meta property="og:image" content="https://mpdesouza.com/images/compass.jpg" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-02-27T12:12:52+00:00" />
<meta property="article:modified_time" content="2021-02-27T12:12:52+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mpdesouza.com/images/compass.jpg" />
<meta name="twitter:title" content="Btrfs: Resolving the logical-resolve"/>
<meta name="twitter:description" content="logical-resolve inside out"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blog",
      "item": "https://mpdesouza.com/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "Btrfs: Resolving the logical-resolve",
      "item": "https://mpdesouza.com/blog/btrfs-resolving-the-logical-resolve/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Btrfs: Resolving the logical-resolve",
  "name": "Btrfs: Resolving the logical-resolve",
  "description": "logical-resolve inside out",
  "keywords": [
    
  ],
  "articleBody": "Tools like fsck and smartctl are usually used when something bad happens on your disk. But, what if such tools have a problem and also need to be fixed? Well, that’s what we are going to see today.\nThe command btrfs inspect-internal logical-resolve, as stated in a previous post, is useful when the btrfs filesystem reports a problem related to data consistency, for example:\n1 2 [2349645.383479] BTRFS error (device sda): bdev /dev/sda errs: wr 0, rd 0, flush 0, corrupt 19, gen 0 [2349645.383483] BTRFS error (device sda): unable to fixup (regular) error at logical 519704576 on dev /dev/sda Btrfs uses blocks groups and chunks to map logical and physical addresses, respectively. The logical address is needed since btrfs has built-in support for multi device and raid.\nTo find what is corruped, we need to find what is the file corresponding to the reported logical address, and this is what logical-resolve was designed to do. This tool is currently failing on some cases, as shown below:\n1 2 $ btrfs inspect-internal logical-resolve 519704576 / ERROR: cannot access '//@/home': No such file or directory As we can see, the command returned -ENOENT and reported an odd path: ’//@/home’. If you had a similar issue, this is most likely because you are using openSUSE/SLE as your Linux distribution, since these systems use @ as it’s top subvolume. For more details about the subvolume layout used in openSUSE check this post from Richard Brown.\nBy looking at the problematic path returned we can assume that logical-resolve is using the full subvolume path when searching for the file. This won’t work because the subvolume @ is not mounted, only it’s child subvolume home:\n1 2 $ mount -l | grep home /dev/sda2 on /home type btrfs (rw,relatime,ssd,space_cache,subvolid=263,subvol=/@/home) In this case the tool should start looking at /home, or in other words, it should be looking at where the subvolume is mounted, not at the subvolume path.\nResolving the resolver We can describe the functionality of logical-resolve in the following steps:\nExecute ioctl BTRFS_IOC_LOGICAL_INO to get all inodes related to the logical address (519704576 in our example), in the root filesystem (/ in our case) For each returned inode Call btrfs_list_path_for_root to get the subvolume path Concatenate the filesystem path (/ in our case) plus the returned subvolume path (/@/home in the example) Call btrfs_open_dir using the path create above (//@/home), returning an fd Call __ino_to_path_fd using the directory fd from btrfs_open_dir and the inode number If __ino_to_path_fd found a valid filename, print the full path (//@/home) plus the filename found. From the steps shown above we can see that step 2.3 will fail. The path /@ is not accessible, only /home. We can fix the problem by changing the behavior and getting the subvolue mount point instead of the subvolume path.\nAn astute reader would think that we can get wrong mount points too, like a bind mount that points to a directory within our desired mount point. This was fixed by the commit mentioned in a previous post.\nWith the bind mount problem resolved, the fixing is a matter of changing step 2.2, like what was done in this patch:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 char *mounted = NULL; char subvol[PATH_MAX]; char subvolid[PATH_MAX]; /* * btrfs_list_path_for_root returns the full * path to the subvolume pointed by root, but the * subvolume can be mounted in a directory name * different from the subvolume name. In this * case we need to find the correct mount point * using same subvolume path and subvol id found * before. */ snprintf(subvol, PATH_MAX, \"/%s\", name); snprintf(subvolid, PATH_MAX, \"%llu\", root); ret = find_mount_fsroot(subvol, subvolid, \u0026mounted); if (ret) { error(\"failed to parse mountinfo\"); goto out; } if (!mounted) { printf( \"inode %llu subvol %s could not be accessed: not mounted\\n\", inum, name); continue; } The new behavior searches for all currently mounted filesystems in order to find the correct mount point related to the subvolume name and subvolume id returned from the BTRFS_IOC_LOGICAL_INO ioctl. This is done by function find_mount_fsroot.\nWith the most recent version of btrfs-progs, logical-resolve works as expected:\n1 2 $ btrfs inspect-internal logical-resolve 5085913088 / //./home/marcos/.local/share/flatpak/repo/objects/00/7e3655177d55a02ca39d4cd3d095627f824b8004ad70f416eccb8bdd281fd5.file The package btrfs-progs v5.10 already contains the fixes pointed in this post, so make sure to upgrade your package in order to have a working logical-resolve.\nThanks for reading!\n",
  "wordCount" : "747",
  "inLanguage": "en",
  "image":"https://mpdesouza.com/images/compass.jpg","datePublished": "2021-02-27T12:12:52Z",
  "dateModified": "2021-02-27T12:12:52Z",
  "author":{
    "@type": "Person",
    "name": "Marcos Paulo de Souza"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mpdesouza.com/blog/btrfs-resolving-the-logical-resolve/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marcos' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mpdesouza.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mpdesouza.com" accesskey="h" title="Marcos&#39; Blog (Alt + H)">Marcos&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mpdesouza.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://mpdesouza.com/about-me/" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mpdesouza.com">Home</a>&nbsp;»&nbsp;<a href="https://mpdesouza.com/blog/">Blog</a></div>
    <h1 class="post-title">
      Btrfs: Resolving the logical-resolve
    </h1>
    <div class="post-meta"><span title='2021-02-27 12:12:52 +0000 UTC'>February 27, 2021</span>&nbsp;·&nbsp;Marcos Paulo de Souza

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://mpdesouza.com/images/compass.jpg" alt="">
        
</figure>
  <div class="post-content"><p>Tools like <a href="https://linux.die.net/man/8/fsck">fsck</a> and <a href="https://linux.die.net/man/8/smartctl">smartctl</a> are usually used when something bad happens on your disk. But, what if such tools have a problem and also need to be fixed? Well, that&rsquo;s what we are going to see today.</p>
<p>The command <strong>btrfs inspect-internal logical-resolve</strong>, as stated in a <a href="/blog/btrfs-differentiating-bind-mounts-on-subvolumes">previous</a> post, is useful when the btrfs filesystem reports a problem related to data consistency, for example:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#91d7e3">[</span>2349645.383479<span style="color:#91d7e3">]</span> BTRFS error <span style="color:#91d7e3">(</span>device sda<span style="color:#91d7e3">)</span>: bdev /dev/sda errs: wr 0, rd 0, flush 0, corrupt 19, gen 0
</span></span><span style="display:flex;"><span><span style="color:#91d7e3">[</span>2349645.383483<span style="color:#91d7e3">]</span> BTRFS error <span style="color:#91d7e3">(</span>device sda<span style="color:#91d7e3">)</span>: unable to fixup <span style="color:#91d7e3">(</span>regular<span style="color:#91d7e3">)</span> error at logical 519704576 on dev /dev/sda
</span></span></code></pre></td></tr></table>
</div>
</div><p>Btrfs uses blocks groups and chunks to map logical and physical addresses, respectively. The logical address is needed since btrfs has built-in support for multi device and raid.</p>
<p>To find what is corruped, we need to find what is the file corresponding to the reported logical address, and this is what <em>logical-resolve</em> was designed to do. This tool is currently failing on some cases, as shown below:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ btrfs inspect-internal logical-resolve 519704576 /
</span></span><span style="display:flex;"><span>ERROR: cannot access <span style="color:#a6da95">&#39;//@/home&#39;</span>: No such file or directory
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, the command returned <strong>-ENOENT</strong> and reported an odd path: <strong>&rsquo;//@/home&rsquo;</strong>. If you had a similar issue, this is most likely because you are using openSUSE/SLE as your Linux distribution, since these systems use <strong>@</strong> as it&rsquo;s top subvolume. For more details  about the subvolume layout used in openSUSE check this <a href="https://rootco.de/2018-01-19-opensuse-btrfs-subvolumes/">post</a> from Richard Brown.</p>
<p>By looking at the problematic path returned we can assume that <em>logical-resolve</em> is using the full subvolume path when searching for the file. This won&rsquo;t work because the subvolume <strong>@</strong> is not mounted, only it&rsquo;s child subvolume <strong>home</strong>:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ mount -l <span style="color:#cad3f5">|</span> grep home
</span></span><span style="display:flex;"><span>/dev/sda2 on /home <span style="font-style:italic">type</span> btrfs <span style="color:#91d7e3">(</span>rw,relatime,ssd,space_cache,subvolid<span style="color:#91d7e3">=</span>263,subvol<span style="color:#91d7e3">=</span>/@/home<span style="color:#91d7e3">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>In this case the tool should start looking at <em>/home</em>, or in other words, it should be looking at where the subvolume is mounted, not at the subvolume path.</p>
<h3 id="resolving-the-resolver">Resolving the resolver<a hidden class="anchor" aria-hidden="true" href="#resolving-the-resolver">#</a></h3>
<p>We can describe the functionality of <em>logical-resolve</em> in the following steps:</p>
<ol>
<li>Execute ioctl <em>BTRFS_IOC_LOGICAL_INO</em> to get all inodes related to the logical address (519704576 in our example), in the root filesystem (/ in our case)</li>
<li>For each returned inode
<ol>
<li>Call <em>btrfs_list_path_for_root</em> to get the subvolume path</li>
<li>Concatenate the filesystem path (/ in our case) plus the returned subvolume path (/@/home in the example)</li>
<li>Call <em>btrfs_open_dir</em> using the path create above (//@/home), returning an fd</li>
<li>Call <em>__ino_to_path_fd</em> using the directory fd from <em>btrfs_open_dir</em> and the inode number</li>
<li>If <em>__ino_to_path_fd</em> found a valid filename, print the full path (//@/home) plus the filename found.</li>
</ol>
</li>
</ol>
<p>From the steps shown above we can see that <strong>step 2.3</strong> will fail. The path <em>/@</em> is not accessible, only <em>/home</em>. We can fix the problem by changing the behavior and getting the <strong>subvolue mount point</strong> instead of the <strong>subvolume path</strong>.</p>
<p>An astute reader would think that we can get wrong mount points too, like a bind mount that points to a directory <em>within</em> our desired mount point. This was fixed by the commit mentioned in a <a href="/blog/btrfs-differentiating-bind-mounts-on-subvolumes">previous</a> post.</p>
<p>With the bind mount problem resolved, the fixing is a matter of changing <strong>step 2.2</strong>, like what was done in this <a href="https://github.com/kdave/btrfs-progs/commit/6b8fed9e798dbcad196e06384b03691ad6512fba">patch</a>:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>				<span style="color:#eed49f">char</span> <span style="color:#91d7e3">*</span><span style="color:#b7bdf8">mounted</span> <span style="color:#91d7e3">=</span> <span style="font-style:italic">NULL</span><span style="color:#cad3f5">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#eed49f">char</span> <span style="color:#b7bdf8">subvol</span><span style="color:#cad3f5">[</span><span style="color:#b7bdf8">PATH_MAX</span><span style="color:#cad3f5">];</span>
</span></span><span style="display:flex;"><span>				<span style="color:#eed49f">char</span> <span style="color:#b7bdf8">subvolid</span><span style="color:#cad3f5">[</span><span style="color:#b7bdf8">PATH_MAX</span><span style="color:#cad3f5">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#5b6078;font-style:italic">/*
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * btrfs_list_path_for_root returns the full
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * path to the subvolume pointed by root, but the
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * subvolume can be mounted in a directory name
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * different from the subvolume name. In this
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * case we need to find the correct mount point
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * using same subvolume path and subvol id found
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 * before.
</span></span></span><span style="display:flex;"><span><span style="color:#5b6078;font-style:italic">				 */</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#91d7e3">snprintf</span><span style="color:#cad3f5">(</span><span style="color:#b7bdf8">subvol</span><span style="color:#cad3f5">,</span> <span style="color:#b7bdf8">PATH_MAX</span><span style="color:#cad3f5">,</span> <span style="color:#a6da95">&#34;/%s&#34;</span><span style="color:#cad3f5">,</span> <span style="color:#b7bdf8">name</span><span style="color:#cad3f5">);</span>
</span></span><span style="display:flex;"><span>				<span style="color:#91d7e3">snprintf</span><span style="color:#cad3f5">(</span><span style="color:#b7bdf8">subvolid</span><span style="color:#cad3f5">,</span> <span style="color:#b7bdf8">PATH_MAX</span><span style="color:#cad3f5">,</span> <span style="color:#a6da95">&#34;%llu&#34;</span><span style="color:#cad3f5">,</span> <span style="color:#b7bdf8">root</span><span style="color:#cad3f5">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#b7bdf8">ret</span> <span style="color:#91d7e3">=</span> <span style="color:#91d7e3">find_mount_fsroot</span><span style="color:#cad3f5">(</span><span style="color:#b7bdf8">subvol</span><span style="color:#cad3f5">,</span> <span style="color:#b7bdf8">subvolid</span><span style="color:#cad3f5">,</span> <span style="color:#91d7e3">&amp;</span><span style="color:#b7bdf8">mounted</span><span style="color:#cad3f5">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#c6a0f6">if</span> <span style="color:#cad3f5">(</span><span style="color:#b7bdf8">ret</span><span style="color:#cad3f5">)</span> <span style="color:#cad3f5">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#91d7e3">error</span><span style="color:#cad3f5">(</span><span style="color:#a6da95">&#34;failed to parse mountinfo&#34;</span><span style="color:#cad3f5">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#c6a0f6">goto</span> <span style="color:#b7bdf8">out</span><span style="color:#cad3f5">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cad3f5">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>				<span style="color:#c6a0f6">if</span> <span style="color:#cad3f5">(</span><span style="color:#91d7e3">!</span><span style="color:#b7bdf8">mounted</span><span style="color:#cad3f5">)</span> <span style="color:#cad3f5">{</span>
</span></span><span style="display:flex;"><span>					<span style="color:#91d7e3">printf</span><span style="color:#cad3f5">(</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6da95">&#34;inode %llu subvol %s could not be accessed: not mounted</span><span style="color:#8aadf4">\n</span><span style="color:#a6da95">&#34;</span><span style="color:#cad3f5">,</span>
</span></span><span style="display:flex;"><span>						<span style="color:#b7bdf8">inum</span><span style="color:#cad3f5">,</span> <span style="color:#b7bdf8">name</span><span style="color:#cad3f5">);</span>
</span></span><span style="display:flex;"><span>					<span style="color:#c6a0f6">continue</span><span style="color:#cad3f5">;</span>
</span></span><span style="display:flex;"><span>				<span style="color:#cad3f5">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The new behavior searches for all currently mounted filesystems in order to find the correct mount point related to the subvolume name and subvolume id returned from the <em>BTRFS_IOC_LOGICAL_INO</em> ioctl. This is done by function <em>find_mount_fsroot</em>.</p>
<p>With the most recent version of btrfs-progs, <em>logical-resolve</em> works as expected:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">2
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span>$ btrfs inspect-internal logical-resolve 5085913088 /
</span></span><span style="display:flex;"><span>//./home/marcos/.local/share/flatpak/repo/objects/00/7e3655177d55a02ca39d4cd3d095627f824b8004ad70f416eccb8bdd281fd5.file
</span></span></code></pre></td></tr></table>
</div>
</div><p>The package btrfs-progs v5.10 already contains the fixes pointed in this post, so make sure to upgrade your package in order to have a working <em>logical-resolve</em>.</p>
<p>Thanks for reading!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mpdesouza.com/blog/btrfs-for-mere-mortals-inode-allocation/">
    <span class="title">« Prev</span>
    <br>
    <span>Btrfs for mere mortals: inode allocation</span>
  </a>
  <a class="next" href="https://mpdesouza.com/blog/btrfs-differentiating-bind-mounts-on-subvolumes/">
    <span class="title">Next »</span>
    <br>
    <span>btrfs: Differentiating bind mounts on subvolumes</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mpdesouza.com">Marcos&#39; Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
