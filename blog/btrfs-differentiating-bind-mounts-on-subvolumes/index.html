<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>btrfs: Differentiating bind mounts on subvolumes | Marcos&#39; Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Explaining how to differentiate bind mounts on btrfs subvolumes">
<meta name="author" content="Marcos Paulo de Souza">
<link rel="canonical" href="https://mpdesouza.com/blog/btrfs-differentiating-bind-mounts-on-subvolumes/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css" integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe&#43;FVUFzPh7U=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mpdesouza.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mpdesouza.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mpdesouza.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mpdesouza.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://mpdesouza.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWD0KKCW2G"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LWD0KKCW2G', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="btrfs: Differentiating bind mounts on subvolumes" />
<meta property="og:description" content="Explaining how to differentiate bind mounts on btrfs subvolumes" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/blog/btrfs-differentiating-bind-mounts-on-subvolumes/" />
<meta property="og:image" content="https://mpdesouza.com/images/btrfs-logo.png" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2021-02-16T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-02-16T00:00:00+00:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mpdesouza.com/images/btrfs-logo.png" />
<meta name="twitter:title" content="btrfs: Differentiating bind mounts on subvolumes"/>
<meta name="twitter:description" content="Explaining how to differentiate bind mounts on btrfs subvolumes"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blog",
      "item": "https://mpdesouza.com/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "btrfs: Differentiating bind mounts on subvolumes",
      "item": "https://mpdesouza.com/blog/btrfs-differentiating-bind-mounts-on-subvolumes/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "btrfs: Differentiating bind mounts on subvolumes",
  "name": "btrfs: Differentiating bind mounts on subvolumes",
  "description": "Explaining how to differentiate bind mounts on btrfs subvolumes",
  "keywords": [
    
  ],
  "articleBody": "The btrfs inspect-internal logical-resolve command is used to find a file related to a logical-address. This can be useful when btrfs reports a corruption at an specific logical address, making it easy for the user to find the corrupted file. But, for all current users of openSUSE/SUSE Enterprise Linux, this command was failing as shown below:\n1 2 btrfs inspect-internal logical-resolve 5085913088 / ERROR: cannot access '//@/home': No such file or directory An openSUSE/SLE installation would create a set of subvolumes, starting from /@. These subvolumes are mounted on /, but @ is never mounted. For example, subvolume /@/home is mounted at /home. We can confirm this behavior by looking at the subvolume list:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 $ btrfs subvolume list / ID 256 gen 32 top level 5 path @ ID 257 gen 416148 top level 256 path @/var ID 258 gen 416148 top level 256 path @/usr/local ID 259 gen 416148 top level 256 path @/tmp ID 260 gen 405918 top level 256 path @/srv ID 261 gen 362296 top level 256 path @/root ID 262 gen 371476 top level 256 path @/opt ID 263 gen 416148 top level 256 path @/home ID 264 gen 131967 top level 256 path @/boot/grub2/x86_64-efi ID 265 gen 28 top level 256 path @/boot/grub2/i386-pc ID 266 gen 354001 top level 256 path @/.snapshots ID 267 gen 416148 top level 266 path @/.snapshots/1/snapshot ID 274 gen 53 top level 266 path @/.snapshots/2/snapshot ID 280 gen 2186 top level 266 path @/.snapshots/7/snapshot ... By checking the fstab file we can verify that all subvolumes are mounted at /, but starting from the subvolume ‘@’:\n1 2 3 4 5 $ cat /etc/fstab ... UUID=35b19e1f-efb2-49a5-ab93-03c04e6d0399 /opt btrfs subvol=/@/opt 0 0 UUID=35b19e1f-efb2-49a5-ab93-03c04e6d0399 /home btrfs subvol=/@/home 0 0 ... The code related to logical-address look at the full subvolume path (/@/home) and tries to follow it, but subvolume /@ isn’t mounted, returning an error. To address it, we need to find the exact mountpoint of the subvolume where the file is mounted, and show the path starting from it.\nThese two patches (patch 1, path 2) fix the issue: finding the correct mountpoint of a subvolume and using it to show the path to the file related to the logical-address.\nIn this post I’ll discuss about the first patch: how to reliably find the correct mountpoint related to a subvolume and a subvolume id.\nSearching for mounted subvolumes As btrfs mount options always show subvolume and subvolume id, it would be simple as:\n1 2 $ cat /proc/mounts | grep btrfs | grep \"subvolid=5,subvol=/\" /storage/btrfs/1.disk on /mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=5,subvol=/) The command above searches in the /proc/mounts file which contain all mountpoints, source, target, filesystem type and filesystem options used to mount.\nIn this case, it works as expect, but what if we have a bind mount mounting from a directory within the current mountpoint? Look at the example below:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 # create a new disk, format it, create a subvolume and a directory on it $ fallocate -l5G test.disk $ mkfs.btrfs -f test.disk $ mount test.disk /mnt $ btrfs subvolume create /mnt/vol1 Create subvolume '/mnt/vol1' $ mount -o subvol=vol1 /mnt $ mkdir /mnt/dir1 $ cat /proc/mounts | grep btrfs | grep \"subvolid=256,subvol=/vol1\" /storage/btrfs/test.disk on /mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=256,subvol=/vol1) $ umount /mnt # bind mount it $ mkdir another_mnt $ mount -o subvol=vol1 /mnt $ mount --bind /mnt/dir1 another_mnt Now, if we run the same command as before, we have a problem:\n1 2 3 $ cat /proc/mounts | grep btrfs | grep \"subvolid=256,subvol=/vol1\" /storage/btrfs/test.disk on /mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=256,subvol=/vol1) /storage/btrfs/test.disk on /storage/btrfs/another_mnt type btrfs (rw,relatime,ssd,space_cache,subvolid=256,subvol=/vol1) As shown, the subvolid and subvol fields are the same, but the content isn’t:\n1 2 3 4 $ ls /mnt dir1 $ ls /storage/btrfs/another_mnt $ Prior to kernel 5.9-rc1, btrfs would show a diferent subvol= option when a bind mount was used. The issue was fixed by this patch. Before this change the /proc/mounts file would differentiate bind mounts:\n1 2 /dev/sda /mnt/test btrfs rw,relatime,subvolid=256,subvol=/foo 0 0 /dev/sda /mnt/test/baz btrfs rw,relatime,subvolid=256,subvol=/foo/bar 0 0 This was wrong, since the subvolume shown should be the same for a bind mount. The patch above fixed the behavior, and now a bind mount will show the same subvol and subvolid fields on a mountpoint:\n1 2 /dev/sda /mnt/test btrfs rw,relatime,subvolid=256,subvol=/foo 0 0 /dev/sda /mnt/test/baz btrfs rw,relatime,subvolid=256,subvol=/foo 0 0 As /proc/mounts can’t be used to differentiate bind mounts, how can we proceed?\nUsing /proc//mountinfo There is a different proc file that shows all mountpoints, accessible by /proc//mountinfo. The comes form the fact that the process can be in a different mount namespace. By using the pid the kernel knows which mountpoints are visible to the process. You can also use self if you want the mountpoints of the current process namespace.\nThe description of all mountinfo fields, along with the /proc/mounts one, can be see in the procfs manpage.\nWhat does mountinfo shows in this setup?\n1 2 3 cat /proc/self/mountinfo | grep btrfs | grep \"subvolid=256,subvol=/vol1\" 37 28 0:31 /vol1 /mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1 36 29 0:31 /vol1/dir1 /storage/btrfs/another_mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1 By looking at the forth field, we can see an interesting info. The manpage describes this field as:\nroot: the pathname of the directory in the filesystem which forms the root of this mount.\nThe mountinfo proc file can show the path within the filesystem used at the mount time. In this case, we just need to check if the forth field contains the same subvolume path specified in the filesystem options.\nWhat if we create a bind mount using the same directory of the original mount?\n1 2 3 4 5 $ umount another_mnt $ mount --bind /mnt/ another_mnt $ cat /proc/self/mountinfo | grep btrfs | grep \"subvolid=256,subvol=/vol1\" 37 28 0:31 /vol1 /mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1 36 29 0:31 /vol1 /storage/btrfs/another_mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid=256,subvol=/vol1 As we can see, both mount roots are the same since both mountpoints have the same contents. The bind mount is just another way of accessing the same content of /mnt.\nI used this approach in this patch in order to solve one of the logical-resolve issues when running the comannd on a openSUSE/SLE distribution. Now the command runs correctly and reports the file related to a logical-address in the filesystem:\n1 2 btrfs inspect-internal logical-resolve 5085913088 / //./home/marcos/.local/share/flatpak/repo/objects/00/7e3655177d55a02ca39d4cd3d095627f824b8004ad70f416eccb8bdd281fd5.file The patch was merged and is already part of btrfs-progs v5.10.1 along with other important fixes.\nThanks for reading!\n",
  "wordCount" : "1114",
  "inLanguage": "en",
  "image":"https://mpdesouza.com/images/btrfs-logo.png","datePublished": "2021-02-16T00:00:00Z",
  "dateModified": "2021-02-16T00:00:00Z",
  "author":{
    "@type": "Person",
    "name": "Marcos Paulo de Souza"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mpdesouza.com/blog/btrfs-differentiating-bind-mounts-on-subvolumes/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marcos' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mpdesouza.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mpdesouza.com" accesskey="h" title="Marcos&#39; Blog (Alt + H)">Marcos&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mpdesouza.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://mpdesouza.com/about-me/" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mpdesouza.com">Home</a>&nbsp;»&nbsp;<a href="https://mpdesouza.com/blog/">Blog</a></div>
    <h1 class="post-title">
      btrfs: Differentiating bind mounts on subvolumes
    </h1>
    <div class="post-meta"><span title='2021-02-16 00:00:00 +0000 UTC'>February 16, 2021</span>&nbsp;·&nbsp;6 min&nbsp;·&nbsp;1114 words&nbsp;·&nbsp;Marcos Paulo de Souza

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://mpdesouza.com/images/btrfs-logo.png" alt="">
        
</figure>
  <div class="post-content"><p>The <em>btrfs inspect-internal logical-resolve</em> command is used to find a file related to a logical-address. This can be useful when btrfs reports a corruption at an specific logical address, making it easy for the user to find the corrupted file. But, for all current users of openSUSE/SUSE Enterprise Linux, this command was failing as shown below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs inspect-internal logical-resolve <span class="m">5085913088</span> / 
</span></span><span class="line"><span class="cl">ERROR: cannot access <span class="s1">&#39;//@/home&#39;</span>: No such file or directory 
</span></span></code></pre></td></tr></table>
</div>
</div><p>An openSUSE/SLE installation would create a set of subvolumes, starting from <em>/@</em>. These subvolumes are mounted on <em>/</em>, but <em>@</em> is never mounted. For example, subvolume <em>/@/home</em> is mounted at <em>/home</em>. We can confirm this behavior by looking at the subvolume list:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ btrfs subvolume list /
</span></span><span class="line"><span class="cl">ID <span class="m">256</span> gen <span class="m">32</span> top level <span class="m">5</span> path @
</span></span><span class="line"><span class="cl">ID <span class="m">257</span> gen <span class="m">416148</span> top level <span class="m">256</span> path @/var
</span></span><span class="line"><span class="cl">ID <span class="m">258</span> gen <span class="m">416148</span> top level <span class="m">256</span> path @/usr/local
</span></span><span class="line"><span class="cl">ID <span class="m">259</span> gen <span class="m">416148</span> top level <span class="m">256</span> path @/tmp
</span></span><span class="line"><span class="cl">ID <span class="m">260</span> gen <span class="m">405918</span> top level <span class="m">256</span> path @/srv
</span></span><span class="line"><span class="cl">ID <span class="m">261</span> gen <span class="m">362296</span> top level <span class="m">256</span> path @/root
</span></span><span class="line"><span class="cl">ID <span class="m">262</span> gen <span class="m">371476</span> top level <span class="m">256</span> path @/opt
</span></span><span class="line"><span class="cl">ID <span class="m">263</span> gen <span class="m">416148</span> top level <span class="m">256</span> path @/home
</span></span><span class="line"><span class="cl">ID <span class="m">264</span> gen <span class="m">131967</span> top level <span class="m">256</span> path @/boot/grub2/x86_64-efi
</span></span><span class="line"><span class="cl">ID <span class="m">265</span> gen <span class="m">28</span> top level <span class="m">256</span> path @/boot/grub2/i386-pc
</span></span><span class="line"><span class="cl">ID <span class="m">266</span> gen <span class="m">354001</span> top level <span class="m">256</span> path @/.snapshots
</span></span><span class="line"><span class="cl">ID <span class="m">267</span> gen <span class="m">416148</span> top level <span class="m">266</span> path @/.snapshots/1/snapshot
</span></span><span class="line"><span class="cl">ID <span class="m">274</span> gen <span class="m">53</span> top level <span class="m">266</span> path @/.snapshots/2/snapshot
</span></span><span class="line"><span class="cl">ID <span class="m">280</span> gen <span class="m">2186</span> top level <span class="m">266</span> path @/.snapshots/7/snapshot
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>By checking the fstab file we can verify that all subvolumes are mounted at /, but starting from the subvolume &lsquo;@&rsquo;:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat /etc/fstab
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>35b19e1f-efb2-49a5-ab93-03c04e6d0399  /opt                    btrfs  <span class="nv">subvol</span><span class="o">=</span>/@/opt                 <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl"><span class="nv">UUID</span><span class="o">=</span>35b19e1f-efb2-49a5-ab93-03c04e6d0399  /home                   btrfs  <span class="nv">subvol</span><span class="o">=</span>/@/home                <span class="m">0</span>  <span class="m">0</span>
</span></span><span class="line"><span class="cl">...
</span></span></code></pre></td></tr></table>
</div>
</div><p>The code related to <em>logical-address</em> look at the full subvolume path (/@/home) and tries to follow it, but subvolume <em>/@</em> isn&rsquo;t mounted, returning an error. To address it, we need to find the exact mountpoint of the subvolume where the file is mounted, and show the path starting from it.</p>
<p>These two patches (<a href="https://github.com/kdave/btrfs-progs/commit/57cfe29e69369be1fd1cfe149ee3cecf37a91968">patch 1</a>, <a href="https://github.com/kdave/btrfs-progs/commit/6b8fed9e798dbcad196e06384b03691ad6512fba">path 2</a>) fix the issue: finding the correct mountpoint of a subvolume and using it to show the path to the file related to the logical-address.</p>
<p>In this post I&rsquo;ll discuss about the first patch: how to reliably find the correct mountpoint related to a subvolume and a subvolume id.</p>
<h3 id="searching-for-mounted-subvolumes">Searching for mounted subvolumes<a hidden class="anchor" aria-hidden="true" href="#searching-for-mounted-subvolumes">#</a></h3>
<p>As btrfs mount options always show subvolume and subvolume id, it would be simple as:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat /proc/mounts <span class="p">|</span> grep btrfs <span class="p">|</span> grep <span class="s2">&#34;subvolid=5,subvol=/&#34;</span>
</span></span><span class="line"><span class="cl">/storage/btrfs/1.disk on /mnt <span class="nb">type</span> btrfs <span class="o">(</span>rw,relatime,ssd,space_cache,subvolid<span class="o">=</span>5,subvol<span class="o">=</span>/<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The command above searches in the <a href="https://man7.org/linux/man-pages/man5/procfs.5.html">/proc/mounts</a> file which contain all mountpoints, source, target, filesystem type and filesystem options used to mount.</p>
<p>In this case, it works as expect, but what if we have a bind mount mounting from a directory <em>within</em> the current mountpoint? Look at the example below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl"><span class="c1"># create a new disk, format it, create a subvolume and a directory on it</span>
</span></span><span class="line"><span class="cl">$ fallocate -l5G test.disk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ mkfs.btrfs -f test.disk
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ mount test.disk /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ btrfs subvolume create /mnt/vol1
</span></span><span class="line"><span class="cl">Create subvolume <span class="s1">&#39;/mnt/vol1&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ mount -o <span class="nv">subvol</span><span class="o">=</span>vol1 /mnt
</span></span><span class="line"><span class="cl">$ mkdir /mnt/dir1
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ cat /proc/mounts <span class="p">|</span> grep btrfs <span class="p">|</span> grep <span class="s2">&#34;subvolid=256,subvol=/vol1&#34;</span>
</span></span><span class="line"><span class="cl">/storage/btrfs/test.disk on /mnt <span class="nb">type</span> btrfs <span class="o">(</span>rw,relatime,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1<span class="o">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ umount /mnt
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># bind mount it</span>
</span></span><span class="line"><span class="cl">$ mkdir another_mnt
</span></span><span class="line"><span class="cl">$ mount -o <span class="nv">subvol</span><span class="o">=</span>vol1 /mnt
</span></span><span class="line"><span class="cl">$ mount --bind /mnt/dir1 another_mnt
</span></span></code></pre></td></tr></table>
</div>
</div><p>Now, if we run the same command as before, we have a problem:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ cat /proc/mounts <span class="p">|</span> grep btrfs <span class="p">|</span> grep <span class="s2">&#34;subvolid=256,subvol=/vol1&#34;</span>
</span></span><span class="line"><span class="cl">/storage/btrfs/test.disk on /mnt <span class="nb">type</span> btrfs <span class="o">(</span>rw,relatime,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1<span class="o">)</span>
</span></span><span class="line"><span class="cl">/storage/btrfs/test.disk on /storage/btrfs/another_mnt <span class="nb">type</span> btrfs <span class="o">(</span>rw,relatime,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1<span class="o">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As shown, the subvolid and subvol fields are the same, but the content isn&rsquo;t:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ ls /mnt
</span></span><span class="line"><span class="cl">dir1
</span></span><span class="line"><span class="cl">$ ls /storage/btrfs/another_mnt
</span></span><span class="line"><span class="cl">$
</span></span></code></pre></td></tr></table>
</div>
</div><p>Prior to kernel 5.9-rc1, btrfs would show a diferent <em>subvol=</em> option when a bind mount was used. The issue was fixed by this <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=3ef3959b29c4a5bd65526ab310a1a18ae533172a">patch</a>. Before this change the <em>/proc/mounts</em> file would differentiate bind mounts:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/dev/sda /mnt/test btrfs rw,relatime,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/foo <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">/dev/sda /mnt/test/baz btrfs rw,relatime,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/foo/bar <span class="m">0</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>This was wrong, since the subvolume shown should be the same for a bind mount. The patch above fixed the behavior, and now a bind mount will show the same subvol and subvolid fields on a mountpoint:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">/dev/sda /mnt/test btrfs rw,relatime,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/foo <span class="m">0</span> <span class="m">0</span>
</span></span><span class="line"><span class="cl">/dev/sda /mnt/test/baz btrfs rw,relatime,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/foo <span class="m">0</span> <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As <em>/proc/mounts</em> can&rsquo;t be used to differentiate bind mounts, how can we proceed?</p>
<h3 id="using-procpidmountinfo">Using /proc/&lt;pid&gt;/mountinfo<a hidden class="anchor" aria-hidden="true" href="#using-procpidmountinfo">#</a></h3>
<p>There is a different proc file that shows all mountpoints, accessible by <em>/proc/&lt;pid&gt;/mountinfo</em>. The <em>&lt;pid&gt;</em> comes form the fact that the process can be in a different <a href="https://man7.org/linux/man-pages/man7/mount_namespaces.7.html">mount namespace</a>. By using the <em>pid</em> the kernel knows which mountpoints are visible to the process. You can also use <em>self</em> if you want the mountpoints of the current process namespace.</p>
<p>The description of all mountinfo fields, along with the /proc/mounts one, can be see in the <a href="https://man7.org/linux/man-pages/man5/procfs.5.html">procfs manpage</a>.</p>
<p>What does <strong>mountinfo</strong> shows in this setup?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">cat /proc/self/mountinfo <span class="p">|</span> grep btrfs <span class="p">|</span> grep <span class="s2">&#34;subvolid=256,subvol=/vol1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">37</span> <span class="m">28</span> 0:31 /vol1 /mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1
</span></span><span class="line"><span class="cl"><span class="m">36</span> <span class="m">29</span> 0:31 /vol1/dir1 /storage/btrfs/another_mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1
</span></span></code></pre></td></tr></table>
</div>
</div><p>By looking at the forth field, we can see an interesting info. The manpage describes this field as:</p>
<blockquote>
<p>root: the pathname of the directory in the filesystem which forms the root of this mount.</p>
</blockquote>
<p>The mountinfo proc file can show the path <em>within</em> the filesystem used at the mount time. In this case, we just need to check if the forth field contains the same subvolume path specified in the filesystem options.</p>
<p>What if we create a bind mount using the same directory of the original mount?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">$ umount another_mnt
</span></span><span class="line"><span class="cl">$ mount --bind /mnt/ another_mnt
</span></span><span class="line"><span class="cl">$ cat /proc/self/mountinfo <span class="p">|</span> grep btrfs <span class="p">|</span> grep <span class="s2">&#34;subvolid=256,subvol=/vol1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="m">37</span> <span class="m">28</span> 0:31 /vol1 /mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1
</span></span><span class="line"><span class="cl"><span class="m">36</span> <span class="m">29</span> 0:31 /vol1 /storage/btrfs/another_mnt rw,relatime - btrfs /dev/loop0 rw,ssd,space_cache,subvolid<span class="o">=</span>256,subvol<span class="o">=</span>/vol1
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see, both mount roots are the same since both mountpoints have the same contents. The bind mount is just another way of accessing the same content of /mnt.</p>
<p>I used this approach in this <a href="https://git.kernel.org/pub/scm/linux/kernel/git/kdave/btrfs-progs.git/commit/?id=57cfe29e69369be1fd1cfe149ee3cecf37a91968">patch</a> in order to solve one of the <em>logical-resolve</em> issues when running the comannd on a openSUSE/SLE distribution. Now the command runs correctly and reports the file related to a logical-address in the filesystem:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">btrfs inspect-internal logical-resolve <span class="m">5085913088</span> /
</span></span><span class="line"><span class="cl">//./home/marcos/.local/share/flatpak/repo/objects/00/7e3655177d55a02ca39d4cd3d095627f824b8004ad70f416eccb8bdd281fd5.file
</span></span></code></pre></td></tr></table>
</div>
</div><p>The patch was merged and is already part of btrfs-progs v5.10.1 along with other important fixes.</p>
<p>Thanks for reading!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mpdesouza.com/blog/btrfs-resolving-the-logical-resolve/">
    <span class="title">« Prev</span>
    <br>
    <span>Btrfs: Resolving the logical-resolve</span>
  </a>
  <a class="next" href="https://mpdesouza.com/blog/btrfs-making-send-more-capable/">
    <span class="title">Next »</span>
    <br>
    <span>btrfs: making &#34;send&#34; more &#34;capable&#34;</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mpdesouza.com">Marcos&#39; Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
